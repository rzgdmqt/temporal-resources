-------------------------------------------------------------
-- Interpretation of well-typed terms in time-varying sets --
-------------------------------------------------------------

open import Semantics.Model

module Semantics.Interpretation (Mod : Model) where

open import Relation.Nullary

open import Syntax.Types
open import Syntax.Contexts
open import Syntax.Language

open import Util.Equality
open import Util.Operations
open import Util.Time

open Model Mod

-- Interpretation of value and computation types

mutual

  โฆ_โงแต : VType โ Obj
  โฆ Base B โงแต  = ConstObj B
  โฆ Unit โงแต    = ๐แต
  โฆ Empty โงแต   = ๐แต
  โฆ A โ C โงแต   = โฆ A โงแต โแต โฆ C โงแถ
  โฆ [ ฯ ] A โงแต = [ ฯ ]แต โฆ A โงแต

  โฆ_โงแถ : CType โ Obj
  โฆ A โผ ฯ โงแถ = Tแต โฆ A โงแต ฯ

  infix 25 โฆ_โงแต
  infix 25 โฆ_โงแถ

-- Relating the interpretation of ground types and ground type to type conversion

โฆโงแต-โฆโงแต : (B : GType) โ โฆ type-of-gtype B โงแต โแต โฆ B โงแต
โฆโงแต-โฆโงแต (Base B) = idแต
โฆโงแต-โฆโงแต Unit     = idแต
โฆโงแต-โฆโงแต Empty    = idแต
โฆโงแต-โฆโงแต ([ ฯ ]แต A) = [ ฯ ]แถ (โฆโงแต-โฆโงแต A)

โฆโงแต-โฆโงแต : (B : GType) โ โฆ B โงแต โแต โฆ type-of-gtype B โงแต
โฆโงแต-โฆโงแต (Base B) = idแต
โฆโงแต-โฆโงแต Unit     = idแต
โฆโงแต-โฆโงแต Empty    = idแต
โฆโงแต-โฆโงแต ([ ฯ ]แต A) = [ ฯ ]แถ (โฆโงแต-โฆโงแต A)

-- Interpretation of contexts as functors

โฆ_โงแตแต : Ctx โ Obj โ Obj
โฆ [] โงแตแต      B = B
โฆ ฮ โท A โงแตแต   B = โฆ ฮ โงแตแต B รแต โฆ A โงแต
โฆ ฮ โจ ฯ โฉ โงแตแต B = โจ ฯ โฉแต (โฆ ฮ โงแตแต B)

โฆ_โงแตแถ : โ {A B} โ (ฮ : Ctx) โ A โแต B โ โฆ ฮ โงแตแต A โแต โฆ ฮ โงแตแต B
โฆ [] โงแตแถ      f = f
โฆ ฮ โท A โงแตแถ   f = mapหฃแต (โฆ ฮ โงแตแถ f) idแต
โฆ ฮ โจ ฯ โฉ โงแตแถ f = โจ ฯ โฉแถ (โฆ ฮ โงแตแถ f)

โฆโงแต-idแต : โ {ฮ A} โ โฆ ฮ โงแตแถ (idแต {A = A}) โก idแต
โฆโงแต-idแต {[]} =
  begin
    idแต
  โกโจโฉ
    idแต
  โ
โฆโงแต-idแต {ฮ โท A} =
  begin
    โจ โฆ ฮ โงแตแถ idแต โแต fstแต , idแต โแต sndแต โฉแต
  โกโจ sym (โจโฉแต-unique _ _ _
       (begin
         fstแต โแต idแต
       โกโจ โแต-identityสณ _ โฉ
         fstแต
       โกโจ sym (โแต-identityหก _) โฉ
         idแต โแต fstแต
       โกโจ โแต-congหก (sym (โฆโงแต-idแต {ฮ})) โฉ
         โฆ ฮ โงแตแถ idแต โแต fstแต
       โ)
       (trans (โแต-identityสณ _) (sym (โแต-identityหก _)))) โฉ
    idแต
  โ
โฆโงแต-idแต {ฮ โจ ฯ โฉ} = 
  begin
    โจ ฯ โฉแถ (โฆ ฮ โงแตแถ idแต)
  โกโจ cong โจ ฯ โฉแถ (โฆโงแต-idแต {ฮ}) โฉ
    โจ ฯ โฉแถ idแต
  โกโจ โจโฉ-idแต โฉ
    idแต
  โ

โฆโงแต-โแต : โ {ฮ A B C} โ (g : B โแต C) โ (f : A โแต B)
       โ โฆ ฮ โงแตแถ (g โแต f) โก โฆ ฮ โงแตแถ g โแต โฆ ฮ โงแตแถ f
โฆโงแต-โแต {[]} g f = 
  begin
    g โแต f
  โกโจโฉ
    g โแต f
  โ
โฆโงแต-โแต {ฮ โท A} g f = 
  begin
    โจ โฆ ฮ โงแตแถ (g โแต f) โแต fstแต , idแต โแต sndแต โฉแต
  โกโจ congโ โจ_,_โฉแต
       (โแต-congหก (โฆโงแต-โแต {ฮ} g f))
       (โแต-congหก (sym (โแต-identityหก _))) โฉ
    โจ (โฆ ฮ โงแตแถ g โแต โฆ ฮ โงแตแถ f) โแต fstแต , (idแต โแต idแต) โแต sndแต โฉแต
  โกโจ mapหฃแต-โแต _ _ _ _ โฉ
       โจ โฆ ฮ โงแตแถ g โแต fstแต , idแต โแต sndแต โฉแต
    โแต โจ โฆ ฮ โงแตแถ f โแต fstแต , idแต โแต sndแต โฉแต
  โ
โฆโงแต-โแต {ฮ โจ ฯ โฉ} g f = 
  begin
    โจ ฯ โฉแถ (โฆ ฮ โงแตแถ (g โแต f))
  โกโจ cong โจ ฯ โฉแถ (โฆโงแต-โแต {ฮ} g f) โฉ
    โจ ฯ โฉแถ (โฆ ฮ โงแตแถ g โแต โฆ ฮ โงแตแถ f)
  โกโจ โจโฉ-โแต _ _ โฉ
    โจ ฯ โฉแถ (โฆ ฮ โงแตแถ g) โแต โจ ฯ โฉแถ (โฆ ฮ โงแตแถ f)
  โ

-- Environments are such functors applied to the terminal object

โฆ_โงแต : Ctx โ Obj
โฆ ฮ โงแต = โฆ ฮ โงแตแต ๐แต

infix 25 โฆ_โงแต

-- Splitting an environment according to context splitting

split-env : โ {ฮ ฮ' ฮ''}
          โ ฮ' , ฮ'' split ฮ
          โ โ {A} โ โฆ ฮ โงแตแต A โแต โฆ ฮ'' โงแตแต (โฆ ฮ' โงแตแต A)
          
split-env split-[]             = idแต
split-env (split-โท p)          = mapหฃแต (split-env p) idแต
split-env (split-โจโฉ {ฯ = ฯ} p) = โจ ฯ โฉแถ (split-env p)

split-envโปยน : โ {ฮ ฮ' ฮ''}
            โ ฮ' , ฮ'' split ฮ
            โ โ {A} โ โฆ ฮ'' โงแตแต (โฆ ฮ' โงแตแต A) โแต โฆ ฮ โงแตแต A

split-envโปยน split-[]             = idแต
split-envโปยน (split-โท p)          = mapหฃแต (split-envโปยน p) idแต
split-envโปยน (split-โจโฉ {ฯ = ฯ} p) = โจ ฯ โฉแถ (split-envโปยน p)

-- Interaction of โจ_โฉ modality and the time-travelling operation on contexts

env-โจโฉ-แถ : โ {ฮ A}
         โ (ฯ : Time) โ ฯ โค ctx-time ฮ
         โ โฆ ฮ โงแตแต A โแต โจ ฯ โฉแต (โฆ ฮ -แถ ฯ โงแตแต A)
         
env-โจโฉ-แถ {ฮ} zero p =
  ฮท
env-โจโฉ-แถ {ฮ โท B} (suc ฯ) p =
     env-โจโฉ-แถ {ฮ} (suc ฯ) p
  โแต fstแต
env-โจโฉ-แถ {ฮ โจ ฯ' โฉ} (suc ฯ) p with suc ฯ โค? ฯ'
... | yes q =
     ฮผโปยน
  โแต โจโฉ-โค (โค-reflexive (m+[nโธm]โกn q))
... | no ยฌq =
     โจโฉ-โค (mโคn+mโธn (suc ฯ) ฯ')
  โแต ฮผ
  โแต โจ ฯ' โฉแถ (env-โจโฉ-แถ {ฮ} (suc ฯ โธ ฯ')
       (โค-trans
         (โธ-monoหก-โค ฯ' p)
         (โค-reflexive (m+nโธnโกm (ctx-time ฮ) ฯ'))))

-- Projecting a variable out of an environment

var-in-env : โ {ฮ A ฯ} โ (x : A โ[ ฯ ] ฮ) โ โฆ ฮ โงแต โแต โฆ A โงแต
var-in-env Hd = sndแต
var-in-env (Tl-โท x) = var-in-env x โแต fstแต
var-in-env (Tl-โจโฉ {ฯ = ฯ} x) = ฮต-โจโฉ โแต โจ ฯ โฉแถ (var-in-env x)

-- Interpretation of well-typed value and computation terms

mutual

  โฆ_โงแตแต : โ {ฮ A} โ ฮ โขVโฆ A โ โฆ ฮ โงแต โแต โฆ A โงแต
  
  โฆ var x โงแตแต = var-in-env x
  
  โฆ const c โงแตแต = constแต c โแต terminalแต
  
  โฆ โ โงแตแต = terminalแต
  
  โฆ lam M โงแตแต = curryแต โฆ M โงแถแต
  
  โฆ box {ฯ = ฯ} V โงแตแต = [ ฯ ]แถ โฆ V โงแตแต โแต ฮทโฃ 

  infix 25 โฆ_โงแตแต


  โฆ_โงแถแต : โ {ฮ C} โ ฮ โขCโฆ C โ โฆ ฮ โงแต โแต โฆ C โงแถ
  
  โฆ return V โงแถแต = ฮทแต โแต โฆ V โงแตแต
  
  โฆ_โงแถแต {ฮ} (_อพ_ {ฯ = ฯ} M N) =
    ฮผแต
    โแต Tแถ โฆ N โงแถแต
    โแต strแต {โจ ฯ โฉแต โฆ ฮ โงแต}
    โแต โจ ฮทโฃ {โฆ ฮ โงแต} , โฆ M โงแถแต โฉแต
        
  โฆ V ยท W โงแถแต = appแต โแต โจ โฆ V โงแตแต , โฆ W โงแตแต โฉแต
  
  โฆ absurd V โงแถแต = initialแต โแต โฆ V โงแตแต
  
  โฆ_โงแถแต {ฮ} (perform {A} {ฯ} op V M) =
    let f : โฆ ฮ โงแต โแต [ op-time op ]แต (โฆ type-of-gtype (arity op) โงแต โแต Tแต โฆ A โงแต ฯ)
        f = [ op-time op ]แถ (curryแต โฆ M โงแถแต) โแต ฮทโฃ in
    let g : [ op-time op ]แต (โฆ type-of-gtype (arity op) โงแต โแต Tแต โฆ A โงแต ฯ)
         โแต [ op-time op ]แต (โฆ arity op โงแต โแต Tแต โฆ A โงแต ฯ)
        g = [ op-time op ]แถ (mapโแต (โฆโงแต-โฆโงแต (arity op)) (idแต {Tแต โฆ A โงแต ฯ})) in
    opแต op โแต โจ โฆโงแต-โฆโงแต (param op) โแต โฆ V โงแตแต , g โแต f โฉแต

  โฆ_โงแถแต {ฮ} (handle_`with_`in {A} {B} {ฯ} {ฯ'} M H N) =
    let f : โฆ ฮ โงแต โแต ฮแต Op (ฮป op โ ฮแต Time (ฮป ฯ'' โ โฆ ฮ โงแต))
        f = โจ (ฮป op โ โจ (ฮป ฯ'' โ idแต) โฉแตขแต) โฉแตขแต in
    let g : (op : Op) โ (ฯ'' : Time)
          โ โฆ type-of-gtype (param op) โงแต รแต [ op-time op ]แต (โฆ type-of-gtype (arity op) โงแต
              โแต (Tแต โฆ B โงแต ฯ'')) โแต Tแต โฆ B โงแต (op-time op + ฯ'')
          โแต โฆ param op โงแต รแต [ op-time op ]แต (โฆ arity op โงแต
              โแต (Tแต โฆ B โงแต ฯ'')) โแต Tแต โฆ B โงแต (op-time op + ฯ'')
        g = ฮป op ฯ'' โ
               mapโแต
                 (mapหฃแต
                   (โฆโงแต-โฆโงแต (param op))
                   ([ op-time op ]แถ (mapโแต (โฆโงแต-โฆโงแต (arity op)) (idแต {Tแต โฆ B โงแต ฯ''}))))
                 (idแต {Tแต โฆ B โงแต (op-time op + ฯ'')}) in
       uncurryแต (
            T-alg-of-handlerแต
         โแต mapโฑหฃแต (ฮป op โ mapโฑหฃแต (ฮป ฯ'' โ
              g op ฯ'' โแต curryแต (โฆ H op ฯ'' โงแถแต โแต รแต-assocโปยน)))
         โแต f)
    โแต mapหฃแต idแต (Tแถ โฆ N โงแถแต)
    โแต mapหฃแต idแต (strแต {โจ ฯ โฉแต โฆ ฮ โงแต})
    โแต โจ idแต , โจ ฮทโฃ {โฆ ฮ โงแต} {ฯ = ฯ} , โฆ M โงแถแต โฉแต โฉแต

  โฆ unbox {ฯ = ฯ} p V M โงแถแต =
    โฆ M โงแถแต โแต โจ idแต ,
                    ฮตโฃ {ฯ = ฯ}
                 โแต (โจ ฯ โฉแถ โฆ V โงแตแต)
                 โแต env-โจโฉ-แถ ฯ p โฉแต

  โฆ delay ฯ M โงแถแต =
       delayแต ฯ
    โแต ([ ฯ ]แถ โฆ M โงแถแต)
    โแต ฮทโฃ 
    
  infix 25 โฆ_โงแถแต

