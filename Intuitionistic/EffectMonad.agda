---------------------------------------------------------------
-- Free graded monad generated by algebraic operations in Op --
---------------------------------------------------------------

open import Function

open import Data.Nat
open import Data.Nat.Properties
open import Data.Product

import Relation.Binary.PropositionalEquality as Eq
open Eq hiding ([_])
open Eq.â‰¡-Reasoning

open import Language

open import TSets
open import ComonadModality
open import MonadModality
open import ModalityAdjunction

module EffectMonad where

-- Base types are interpreted as constant presheaves

BaseTSet : BaseType â†’ TSet
BaseTSet B = tset (Î» _ â†’ BaseSet B) (Î» _ â†’ id) (Î» _ â†’ refl) (Î» _ _ _ â†’ refl)

constáµ— : âˆ€ {B} â†’ BaseSet B â†’ ğŸ™áµ— â†’áµ— BaseTSet B
constáµ— c = tset-map (Î» _ â†’ c)

-- Interpretation of ground types

âŸ¦_âŸ§áµ : GType â†’ TSet
âŸ¦ Base B âŸ§áµ = BaseTSet B
âŸ¦ Unit âŸ§áµ   = ğŸ™áµ—
âŸ¦ Empty âŸ§áµ  = ğŸ˜áµ—

âŸ¦âŸ§áµ-constant : (B : GType) â†’ (t t' : Time) â†’ carrier âŸ¦ B âŸ§áµ t â†’ carrier âŸ¦ B âŸ§áµ t'
âŸ¦âŸ§áµ-constant (Base B) t t' = id
âŸ¦âŸ§áµ-constant Unit     t t' = id
âŸ¦âŸ§áµ-constant Empty    t t' = id

-- Object-mapping of the underlying functor

data TË¢ (A : TSet) : (Ï„ : Time) â†’ (t : Time) â†’ Set where  -- 1st time index (Ï„) is the duration of the computation (its time-grading)
                                                          -- 2nd time index (t) is the corresponding TSets' time-index (modal time)
  leaf : âˆ€ {Ï„ t}
       â†’ carrier A (Ï„ + t)
       â†’ TË¢ A Ï„ t

  node : âˆ€ {Ï„ Ï„' t}
       â†’ (op : Op)
       â†’ carrier âŸ¦ param op âŸ§áµ t
       â†’ ({t' : Time} â†’ t + op-time op â‰¤ t' â†’ carrier (âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A Ï„ t')  -- intuitively, [ op-time op ] (âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„)
       â†’ Ï„' â‰¡ op-time op + Ï„                                                           -- abstracting into a variable for easier recursive defs.
       â†’ TË¢ A Ï„' t

-- Monotonicity wrt TSets' time-indices

TË¢-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„ t'
TË¢-â‰¤t {A} p (leaf a) =
  leaf (monotone A (+-monoÊ³-â‰¤ _ p) a)
TË¢-â‰¤t {A} p (node op v k q) =
  node
    op (monotone âŸ¦ param op âŸ§áµ p v)
    (Î» q y â†’ TË¢-â‰¤t â‰¤-refl (k (â‰¤-trans (+-monoË¡-â‰¤ (op-time op) p) q) y)) q

TË¢-â‰¤t-refl : âˆ€ {A Ï„ t} â†’ (c : TË¢ A Ï„ t) â†’ TË¢-â‰¤t â‰¤-refl c â‰¡ c
TË¢-â‰¤t-refl {A} (leaf v) =
  cong
    leaf
    (trans
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ â‰¤-refl))
      (monotone-refl A v))
TË¢-â‰¤t-refl {A} (node {Ï„} {Ï„'} {t} op v k p) =
  trans
    (cong
      (Î» v â†’ node op v _ p)
      (monotone-refl âŸ¦ param op âŸ§áµ v))
    (cong
      (Î» (k : ({t' : Time} â†’ t + op-time op â‰¤ t'
                           â†’ carrier (âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A Ï„ t')) â†’ node op v k p)
      (ifun-ext (fun-ext (Î» q â†’ fun-ext (Î» y â†’
        trans
          (cong (Î» q â†’ TË¢-â‰¤t â‰¤-refl (k q y)) (â‰¤-irrelevant _ _))
          (TË¢-â‰¤t-refl (k q y)))))))

TË¢-â‰¤t-trans : âˆ€ {A Ï„ t t' t''} â†’ (p : t â‰¤ t') â†’ (q : t' â‰¤ t'')
            â†’ (c : TË¢ A Ï„ t) â†’ TË¢-â‰¤t q (TË¢-â‰¤t p c) â‰¡ TË¢-â‰¤t (â‰¤-trans p q) c

TË¢-â‰¤t-trans {A} p q (leaf v) =
  cong
    leaf
    (trans
      (monotone-trans A _ _ v)
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ _)))
TË¢-â‰¤t-trans {A} p q (node op v k r) =
  trans
    (cong
      (Î» v â†’ node op v _ r)
      (monotone-trans âŸ¦ param op âŸ§áµ p q v))
    (cong (Î» (k : ({t' : Time} â†’ _ + op-time op â‰¤ t'
                               â†’ carrier (âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A _ t'))
                               â†’ node op (monotone âŸ¦ param op âŸ§áµ (â‰¤-trans p q) v) k r)
       (ifun-ext (fun-ext (Î» s â†’ fun-ext (Î» c â†’
         trans
           (TË¢-â‰¤t-trans (â‰¤-reflexive refl) (â‰¤-reflexive refl) _)
           (congâ‚‚ TË¢-â‰¤t
             (â‰¤-irrelevant _ _)
             (cong (Î» p â†’ k p c) (â‰¤-irrelevant _ _))))))))

-- Monotonicity wrt time-gradings

TË¢-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„' t
TË¢-â‰¤Ï„ {A} p (leaf v) = leaf (monotone A (+-monoË¡-â‰¤ _ p) v)
TË¢-â‰¤Ï„ p (node op v k q) =
  node
    op v
    (Î» r y â†’ TË¢-â‰¤Ï„ (projâ‚‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p))) (k r y))
    (trans (projâ‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p))) (+-comm _ (op-time op)))

-- Functorial action on â†’áµ—

TË¢á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B Ï„ t
TË¢á¶  (tset-map f) (leaf a)   =
  leaf (f a)
TË¢á¶  (tset-map f) (node op v k q) =
  node op v (Î» p y â†’ TË¢á¶  (tset-map f) (k p y)) q

-- Packaging it all up into a functor

Táµ’ : TSet â†’ Time â†’ TSet
Táµ’ A Ï„ = tset (Î» t â†’ TË¢ A Ï„ t) TË¢-â‰¤t TË¢-â‰¤t-refl TË¢-â‰¤t-trans

Tá¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ Táµ’ A Ï„ â†’áµ— Táµ’ B Ï„
Tá¶  f = tset-map (TË¢á¶  f)

T-â‰¤Ï„ : âˆ€ {A Ï„ Ï„'} â†’ Ï„ â‰¤ Ï„' â†’ Táµ’ A Ï„ â†’áµ— Táµ’ A Ï„'
T-â‰¤Ï„ p = tset-map (TË¢-â‰¤Ï„ p)

-- Unit

Î·áµ€ : âˆ€ {A} â†’ A â†’áµ— Táµ’ A 0
Î·áµ€ = tset-map (Î» v â†’ leaf v)

-- T is a [_]-module

T-[]-moduleË¢ : âˆ€ {A Ï„ Ï„' t} â†’ TË¢ A Ï„' (t + Ï„) â†’ TË¢ A (Ï„ + Ï„') t
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (leaf v) =
  leaf (monotone A (â‰¤-reflexive (trans
                          (trans
                            (cong (Ï„' +_) (+-comm t Ï„))
                            (sym (+-assoc Ï„' Ï„ t)))
                          (cong (_+ t) (+-comm Ï„' Ï„)))) v)
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (node {Ï„ = Ï„''} op v k p) =
  node op
    (âŸ¦âŸ§áµ-constant (param op) (t + Ï„) t v)    -- can't use monotonicity of the parameter type
    (Î» {t'} q y â†’ T-[]-moduleË¢ (k (â‰¤-trans
                                    (â‰¤-reflexive
                                      (trans
                                        (+-assoc t Ï„ (op-time op))
                                        (trans
                                          (cong (t +_) (+-comm Ï„ (op-time op)))
                                          (sym (+-assoc t (op-time op) Ï„)))))
                                    (+-monoË¡-â‰¤ Ï„ q))
                                  (monotone âŸ¦ arity op âŸ§áµ (mâ‰¤m+n t' Ï„) y)))  -- could also have used âŸ¦âŸ§áµ-constant
    (trans
      (cong (Ï„ +_) p)
      (trans
        (sym (+-assoc Ï„ (op-time op) Ï„''))
        (trans
          (cong (_+ Ï„'') (+-comm Ï„ (op-time op)))
          (+-assoc (op-time op) Ï„ _))))

T-[]-module : âˆ€ {A Ï„ Ï„'} â†’ [ Ï„ ]áµ’ (Táµ’ A Ï„') â†’áµ— Táµ’ A (Ï„ + Ï„')
T-[]-module = tset-map T-[]-moduleË¢

-- Kleisli extension

kl-extË¢ : âˆ€ {A B Ï„ Ï„'} â†’ {t : Time}
        â†’ carrier (Táµ’ A Ï„) t
        â†’ carrier ([ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')) t
        â†’ carrier (Táµ’ B (Ï„ + Ï„')) t
        
kl-extË¢ {A} {B} {Ï„' = Ï„'} (leaf {Ï„} {t} v) f =
  T-[]-moduleË¢
    (monotone
      (Táµ’ B Ï„')
      (â‰¤-reflexive (+-comm Ï„ t))
      (f (â‰¤-reflexive (+-comm t Ï„)) v))
kl-extË¢ {A = A} {B = B} {Ï„' = Ï„'} {t} (node {Ï„ = Ï„} op v k p) f =
  node op v
    (Î» {t'} q y â†’
      kl-extË¢
        (k q y)
        (Î» {t''} r x â†’
          f (â‰¤-trans
              (â‰¤-trans
                (â‰¤-reflexive (cong (t +_) p))
                (â‰¤-trans
                  (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„)))
                  (+-monoË¡-â‰¤ Ï„ q))) r)
            x))
    (trans (cong (_+ Ï„') p) (+-assoc (op-time op) Ï„ Ï„'))

kl-extáµ€ : âˆ€ {A B Ï„ Ï„'} â†’ Táµ’ A Ï„ Ã—áµ— [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„') â†’áµ— Táµ’ B (Ï„ + Ï„')
kl-extáµ€ = tset-map (Î» (c , f) â†’ kl-extË¢ c f)

-- Algebraic operations

opáµ€ : âˆ€ {A Ï„} â†’ (op : Op)
    â†’ âŸ¦ param op âŸ§áµ Ã—áµ— ([ op-time op ]áµ’ (âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„)) â†’áµ— Táµ’ A (op-time op + Ï„)
opáµ€ op = tset-map (Î» { (v , k) â†’ node op v k refl })
