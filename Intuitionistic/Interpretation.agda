--------------------------------------------------------
-- Interpretation of well-typed terms in time-indexed --
--------------------------------------------------------

open import Function

open import Data.Nat
open import Data.Nat.Properties
open import Data.Product

import Relation.Binary.PropositionalEquality as Eq
open Eq hiding ([_])
open Eq.â‰¡-Reasoning

open import Language
open import TSets

module Interpretation where

-- Base types are interpreted as constant presheaves

BaseTSet : BaseType â†’ TSet
BaseTSet B = tset (Î» _ â†’ BaseSet B) (Î» _ â†’ id)

-- Interpretation of ground types

âŸ¦_âŸ§áµ : GType â†’ TSet
âŸ¦ Base B âŸ§áµ = BaseTSet B
âŸ¦ Unit âŸ§áµ   = ğŸ™áµ—
âŸ¦ Empty âŸ§áµ  = ğŸ˜áµ—

âŸ¦âŸ§áµ-constant : (B : GType) â†’ (t t' : Time) â†’ carrier âŸ¦ B âŸ§áµ t â†’ carrier âŸ¦ B âŸ§áµ t'
âŸ¦âŸ§áµ-constant (Base B) t t' = id
âŸ¦âŸ§áµ-constant Unit     t t' = id
âŸ¦âŸ§áµ-constant Empty    t t' = id

-- Free graded monad generated by algebraic operations

---- object-mapping of the underlying functor

data TË¢ (A : TSet) : (Ï„ : Time) â†’ (t : Time) â†’ Set where  -- 1st time index (Ï„) is the duration of the computation (monad's grading)
                                                          -- 2nd time index (t) is the corresponding TSets' time-index (modal time)
  leaf : âˆ€ {Ï„ t}
       â†’ carrier A (Ï„ + t)
       â†’ TË¢ A Ï„ t

  node : âˆ€ {Ï„ Ï„' t}
       â†’ (op : Op)
       â†’ carrier âŸ¦ param op âŸ§áµ t
       â†’ ((t' : Time) â†’ t â‰¤ t' â†’ carrier (âŸ¨ op-time op âŸ©áµ’ âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A Ï„ t')
       â†’ Ï„' â‰¡ op-time op + Ï„
       â†’ TË¢ A Ï„' t

---- interaction between gradings and TSets' time indices

TË¢-move-+ : âˆ€ {A Ï„ Ï„' t} â†’ TË¢ A Ï„ (Ï„' + t) â†’ TË¢ A (Ï„' + Ï„) t
TË¢-move-+ {(tset A Af)} {Ï„} {Ï„'} {t} (leaf v) =
  leaf (Af (â‰¤-reflexive (trans (sym (+-assoc Ï„ Ï„' t)) (cong (_+ t) (+-comm Ï„ Ï„')))) v)
TË¢-move-+ {(tset A Af)} {Ï„} {Ï„'} {t} (node op v k q) =
  node op
    (âŸ¦âŸ§áµ-constant (param op) (Ï„' + t) t v)
    (Î» { t' r (s , y) â†’ TË¢-move-+ (k (Ï„' + t')
                                     (+-mono-â‰¤ â‰¤-refl r)
                                     (â‰¤-stepsË¡ Ï„' s ,
                                      âŸ¦âŸ§áµ-constant (arity op) (t' âˆ¸ op-time op) (Ï„' + t' âˆ¸ op-time op) y))})
    (trans
      (+-comm Ï„' Ï„)
      (trans
        (cong (_+ Ï„') q)
        (trans
          (+-assoc (op-time op) _ Ï„')
          (cong (op-time op +_) (+-comm _ Ï„')))))

---- monotonicity wrt TSets' time-indices

TË¢-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„ t'
TË¢-â‰¤t {(tset A Af)} p (leaf a) =
  leaf (Af (+-mono-â‰¤ â‰¤-refl p) a)
TË¢-â‰¤t {(tset A Af)} p (node op v k q) =
  node
    op (monotone âŸ¦ param op âŸ§áµ p v)
    (Î» t' q y â†’ TË¢-â‰¤t â‰¤-refl (k t' (â‰¤-trans p q) y)) q

---- monotonicity wrt gradings

TË¢-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„' t
TË¢-â‰¤Ï„ {(tset A Af)} p (leaf v) = leaf (Af (+-mono-â‰¤ p â‰¤-refl) v)
TË¢-â‰¤Ï„ {(tset A Af)} p (node op v k q) =
  node
    op v
    (Î» t' r y â†’ TË¢-â‰¤Ï„ (projâ‚‚ (projâ‚‚ (â‰¤-split-+ (trans q (+-comm (op-time op) _)) p))) (k t' r y))
    (trans (projâ‚ (projâ‚‚ (â‰¤-split-+ (trans q (+-comm (op-time op) _)) p))) (+-comm _ (op-time op)))

---- functorial action on TSet-maps

TË¢á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B Ï„ t
TË¢á¶  (tset-map f) (leaf a)   =
  leaf (f a)
TË¢á¶  (tset-map f) (node op v k q) =
  node op v (Î» t' p y â†’ TË¢á¶  (tset-map f) (k t' p y)) q

---- packaging it all up into a functor on TSet

Táµ’ : TSet â†’ Time â†’ TSet
Táµ’ A Ï„ = tset (Î» t â†’ TË¢ A Ï„ t) TË¢-â‰¤t

Tá¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ Táµ’ A Ï„ â†’áµ— Táµ’ B Ï„
Tá¶  f = tset-map (TË¢á¶  f)

T-â‰¤Ï„ : âˆ€ {A Ï„ Ï„'} â†’ Ï„ â‰¤ Ï„' â†’ Táµ’ A Ï„ â†’áµ— Táµ’ A Ï„'
T-â‰¤Ï„ p = tset-map (TË¢-â‰¤Ï„ p)

---- unit of the graded monad

Î·áµ€ : âˆ€ {A} â†’ A â†’áµ— Táµ’ A 0
Î·áµ€ = tset-map (Î» v â†’ leaf v)

---- Kleisli extension of the graded monad

extendË¢ : âˆ€ {A B Ï„ Ï„'} â†’ A â†’áµ— Táµ’ B Ï„' â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B (Ï„ + Ï„') t
extendË¢ (tset-map f) (leaf v) = TË¢-move-+ (f v)
extendË¢ {Ï„ = Ï„} {Ï„' = Ï„'} (tset-map f) (node op v k q) =
  node op v
    (Î» t' r y â†’ extendË¢ (tset-map f) (k t' r y))
    (trans (cong (_+ _) q) (+-assoc (op-time op) _ _))

extendáµ€ : âˆ€ {A B Ï„ Ï„'} â†’ A â†’áµ— Táµ’ B Ï„' â†’ Táµ’ A Ï„ â†’áµ— Táµ’ B (Ï„ + Ï„')
extendáµ€ f = tset-map (extendË¢ f)

---- Algebraic operations associated with the graded monad

opáµ— : âˆ€ {A Ï„ Ï„'}
    â†’ (op : Op) â†’ Ï„' â‰¡ op-time op + Ï„
    â†’ âŸ¦ param op âŸ§áµ Ã—áµ— (âŸ¨ op-time op âŸ©áµ’ âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„) â†’áµ— Táµ’ A Ï„'
opáµ— op p = tset-map Î» { (v , k) â†’ node op v k p }

-- Interpretation of value and computation types

mutual

  âŸ¦_âŸ§áµ› : VType â†’ TSet
  âŸ¦ Base B âŸ§áµ›  = BaseTSet B
  âŸ¦ Unit âŸ§áµ›    = ğŸ™áµ—
  âŸ¦ Empty âŸ§áµ›   = ğŸ˜áµ—
  âŸ¦ A â‡’ C âŸ§áµ›   = âŸ¦ A âŸ§áµ› â‡’áµ— âŸ¦ C âŸ§á¶œ
  âŸ¦ [ Ï„ ] A âŸ§áµ› = [ Ï„ ]áµ’ âŸ¦ A âŸ§áµ›

  âŸ¦_âŸ§á¶œ : CType â†’ TSet
  âŸ¦ A â€¼ Ï„ âŸ§á¶œ = Táµ’ âŸ¦ A âŸ§áµ› Ï„

  infix 25 âŸ¦_âŸ§áµ›
  infix 25 âŸ¦_âŸ§á¶œ

-- Relating the interpretation of ground types and ground type to type conversion

âŸ¦âŸ§áµ›-âŸ¦âŸ§áµ : (B : GType) â†’ âŸ¦ type-of-gtype B âŸ§áµ› â†’áµ— âŸ¦ B âŸ§áµ
âŸ¦âŸ§áµ›-âŸ¦âŸ§áµ (Base B) = tset-map id
âŸ¦âŸ§áµ›-âŸ¦âŸ§áµ Unit     = tset-map id
âŸ¦âŸ§áµ›-âŸ¦âŸ§áµ Empty    = tset-map id

-- Interpretation of contexts as environments

âŸ¦_âŸ§áµ‰ : Ctx â†’ TSet
âŸ¦ [] âŸ§áµ‰      = ğŸ™áµ—
âŸ¦ Î“ âˆ·á¶œ A âŸ§áµ‰  = âŸ¦ Î“ âŸ§áµ‰ Ã—áµ— âŸ¦ A âŸ§áµ›
âŸ¦ Î“ âŸ¨ Ï„ âŸ© âŸ§áµ‰ = âŸ¨ Ï„ âŸ©áµ’ âŸ¦ Î“ âŸ§áµ‰

infix 25 âŸ¦_âŸ§áµ‰

-- Interpretation of well-typed value and computation terms

mutual

  âŸ¦_âŸ§áµ›áµ— : âˆ€ {Î“ A} â†’ Î“ âŠ¢Vâ¦‚ A â†’ âŸ¦ Î“ âŸ§áµ‰ â†’áµ— âŸ¦ A âŸ§áµ›
  âŸ¦ var x âŸ§áµ›áµ—         = {!!}
  âŸ¦ const c âŸ§áµ›áµ—       = tset-map (Î» _ â†’ c)
  âŸ¦ âŸ¨âŸ© âŸ§áµ›áµ—            = terminaláµ—
  âŸ¦ lam M âŸ§áµ›áµ—         = {!âŸ¦ M âŸ§á¶œáµ—!}
  âŸ¦ box {Ï„ = Ï„} V âŸ§áµ›áµ— = ([ Ï„ ]á¶  âŸ¦ V âŸ§áµ›áµ—) âˆ˜áµ— Î·âŠ£ 

  âŸ¦_âŸ§á¶œáµ— : âˆ€ {Î“ C} â†’ Î“ âŠ¢Câ¦‚ C â†’ âŸ¦ Î“ âŸ§áµ‰ â†’áµ— âŸ¦ C âŸ§á¶œ
  âŸ¦ return V âŸ§á¶œáµ—       = T-â‰¤Ï„ zâ‰¤n âˆ˜áµ— Î·áµ€ âˆ˜áµ— âŸ¦ V âŸ§áµ›áµ—
  âŸ¦ M Í¾ N âŸ§á¶œáµ—          = {!!}
  âŸ¦ V Â· W âŸ§á¶œáµ—          = appáµ— âˆ˜áµ— âŸ¨ âŸ¦ V âŸ§áµ›áµ— , âŸ¦ W âŸ§áµ›áµ— âŸ©áµ—
  âŸ¦ absurd V âŸ§á¶œáµ—       = initialáµ— âˆ˜áµ— âŸ¦ V âŸ§áµ›áµ—
  âŸ¦ perform op V M âŸ§á¶œáµ— = opáµ— op refl âˆ˜áµ— âŸ¨ âŸ¦âŸ§áµ›-âŸ¦âŸ§áµ (param op) âˆ˜áµ— âŸ¦ V âŸ§áµ›áµ— , {!âŸ¦ M âŸ§á¶œáµ—!} âŸ©áµ—
  âŸ¦ unbox V p q âŸ§á¶œáµ—    = {!!}
  âŸ¦ coerce p M âŸ§á¶œáµ—     = T-â‰¤Ï„ p âˆ˜áµ— âŸ¦ M âŸ§á¶œáµ—
