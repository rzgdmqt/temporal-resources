--------------------------------------------------------
-- Interpretation of well-typed terms in time-indexed --
--------------------------------------------------------

open import Function

open import Data.Nat
open import Data.Nat.Properties
open import Data.Product

import Relation.Binary.PropositionalEquality as Eq
open Eq hiding ([_])
open Eq.â‰¡-Reasoning

open import Language
open import TSets

module Interpretation where

-- Base types are interpreted as constant presheaves

postulate
  BaseSet : BaseType â†’ Set

BaseTSet : BaseType â†’ TSet
BaseTSet B = tset (Î» _ â†’ BaseSet B) (Î» _ â†’ id)

-- Interpretation of ground types

âŸ¦_âŸ§áµ : GType â†’ TSet
âŸ¦ Base B âŸ§áµ = BaseTSet B
âŸ¦ Unit âŸ§áµ   = ğŸ™áµ—
âŸ¦ Empty âŸ§áµ  = ğŸ˜áµ—

-- Free graded monad generated by algebraic operations

data TË¢ (A : TSet) : (Ï„ : Time) â†’ (t : Time) â†’ Set where  -- 1st time index (Ï„) is the duration of the computation (monad's grading)
                                                          -- 2nd time index (t) is the corresponding TSet time-index (modal time)
  leaf : âˆ€ {Ï„ t}
       â†’ TSet.carrier A (Ï„ + t)
       â†’ TË¢ A Ï„ t

  node : âˆ€ {Ï„ Ï„' t}
       â†’ (op : Op)
       â†’ TSet.carrier âŸ¦ param op âŸ§áµ t
       â†’ ((t' : Time) â†’ t â‰¤ t' â†’ TSet.carrier (âŸ¨ op-time op âŸ©áµ’ âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A Ï„ t')
       â†’ Ï„' â‰¡ op-time op + Ï„
       â†’ TË¢ A Ï„' t

TË¢-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„ t'
TË¢-â‰¤t {(tset A Af)} p (leaf a) =
  leaf (Af (+-mono-â‰¤ â‰¤-refl p) a)
TË¢-â‰¤t {(tset A Af)} p (node op v k q) =
  node
    op (TSet.monotone âŸ¦ param op âŸ§áµ p v)
    (Î» t' q y â†’ TË¢-â‰¤t â‰¤-refl (k t' (â‰¤-trans p q) y)) q

TË¢-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„' t
TË¢-â‰¤Ï„ {(tset A Af)} p (leaf v) = leaf (Af (+-mono-â‰¤ p â‰¤-refl) v)
TË¢-â‰¤Ï„ {(tset A Af)} p (node op v k q) =
  node
    op v
    (Î» t' r y â†’ TË¢-â‰¤Ï„ (projâ‚‚ (projâ‚‚ (â‰¤-split-+ q p (no-stutter op)))) (k t' r y))
    (projâ‚ (projâ‚‚ (â‰¤-split-+ q p (no-stutter op))))

TË¢á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B Ï„ t
TË¢á¶  (tset-map f) (leaf a)   =
  leaf (f a)
TË¢á¶  (tset-map f) (node op v k q) =
  node op v (Î» t' p y â†’ TË¢á¶  (tset-map f) (k t' p y)) q

Táµ’ : TSet â†’ Time â†’ TSet
Táµ’ A Ï„ = tset (Î» t â†’ TË¢ A Ï„ t) TË¢-â‰¤t

-- Interpretation of types

mutual

  âŸ¦_âŸ§áµ› : VType â†’ TSet
  âŸ¦ Base B âŸ§áµ›  = BaseTSet B
  âŸ¦ Unit âŸ§áµ›    = ğŸ™áµ—
  âŸ¦ Empty âŸ§áµ›   = ğŸ˜áµ—
  âŸ¦ A â‡’ C âŸ§áµ›   = âŸ¦ A âŸ§áµ› â‡’áµ— âŸ¦ C âŸ§á¶œ
  âŸ¦ [ Ï„ ] A âŸ§áµ› = [ Ï„ ]áµ’ âŸ¦ A âŸ§áµ›

  âŸ¦_âŸ§á¶œ : CType â†’ TSet
  âŸ¦ A â€¼ Ï„ âŸ§á¶œ = Táµ’ âŸ¦ A âŸ§áµ› Ï„

  infix 25 âŸ¦_âŸ§áµ›
  infix 25 âŸ¦_âŸ§á¶œ
