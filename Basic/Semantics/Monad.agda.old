---------------------------------------------------------
-- Free graded monad generated by algebraic operations --
---------------------------------------------------------

open import Function

open import Data.Empty
open import Data.Product
open import Data.Unit hiding (_â‰¤_)

open import Semantics.TSets
open import Semantics.Modality.Future
open import Semantics.Modality.Past

open import Util.HProp
open import Util.Equality
open import Util.Operations
open import Util.Time

module Semantics.Monad where

-- Interpretation of ground types as sets

âŸ¦_âŸ§áµ : GType â†’ TSet
âŸ¦ Base B âŸ§áµ   = ConstTSet (BaseSet B)
âŸ¦ Unit âŸ§áµ     = ğŸ™áµ—
âŸ¦ Empty âŸ§áµ    = ğŸ˜áµ—
âŸ¦ [ Ï„ ]áµ A âŸ§áµ = [ Ï„ ]áµ’ âŸ¦ A âŸ§áµ

-- The free graded monad generated by the operations in Op

-- TODO: work out the formal details of the corresponding
--       definitions (postulating them for time being)



{-

-- OLDER EXPERIMENTS WITH DEFINING THE FREE MONAD ON THE PRESHEAF CATEGORY

-- Object-mapping of the underlying functor

data TË¢ (A : TSet) : (Ï„ : Time) â†’ (t : Time) â†’ Set where  -- 1st time index (Ï„) is the duration of the computation (its time-grading)
                                                          -- 2nd time index (t) is the corresponding TSets' time-index (modal time)
  leaf : âˆ€ {Ï„ t}
       â†’ carrier A (Ï„ + t)
       â†’ TË¢ A Ï„ t

  node : âˆ€ {Ï„ Ï„' t}
       â†’ (op : Op)
       â†’ carrier (ConstTSet âŸ¦ param op âŸ§áµ) t
       â†’ ({t' : Time} â†’ t + op-time op â‰¤ t'
                      â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'
                      â†’ TË¢ A Ï„ t')
       â†’ Ï„' â‰¡ op-time op + Ï„                                    -- abstracting into a variable for easier recursive defs.
       â†’ TË¢ A Ï„' t

-- Monotonicity wrt TSets' time-indices

TË¢-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„ t'
TË¢-â‰¤t {A} p (leaf a) =
  leaf (monotone A (+-monoÊ³-â‰¤ _ p) a)
TË¢-â‰¤t {A} p (node op v k q) =
  node op v (Î» q y â†’ k (â‰¤-trans (+-monoË¡-â‰¤ (op-time op) p) q) y) q

TË¢-â‰¤t-refl : âˆ€ {A Ï„ t} â†’ (c : TË¢ A Ï„ t) â†’ TË¢-â‰¤t â‰¤-refl c â‰¡ c
TË¢-â‰¤t-refl {A} (leaf v) =
  cong
    leaf
    (trans
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ â‰¤-refl))
      (monotone-refl A v))
TË¢-â‰¤t-refl {A} (node {Ï„} {Ï„'} {t} op v k p) =
  cong
    (Î» (k : ({t' : Time} â†’ t + op-time op â‰¤ t'
                         â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'
                         â†’ TË¢ A Ï„ t'))
      â†’ node op v k p)
    (ifun-ext (fun-ext (Î» q â†’ fun-ext (Î» y â†’
      cong (Î» q â†’ k q y) (â‰¤-irrelevant _ _)))))

TË¢-â‰¤t-trans : âˆ€ {A Ï„ t t' t''}
            â†’ (p : t â‰¤ t') â†’ (q : t' â‰¤ t'') â†’ (c : TË¢ A Ï„ t)
            â†’ TË¢-â‰¤t q (TË¢-â‰¤t p c) â‰¡ TË¢-â‰¤t (â‰¤-trans p q) c

TË¢-â‰¤t-trans {A} p q (leaf v) =
  cong
    leaf
    (trans
      (monotone-trans A _ _ v)
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ _)))
TË¢-â‰¤t-trans {A} p q (node op v k r) =
  cong (Î» (k : ({t' : Time} â†’ _ + op-time op â‰¤ t'
                            â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A _ t'))
                            â†’ node op (monotone (ConstTSet âŸ¦ param op âŸ§áµ) (â‰¤-trans p q) v) k r)
    (ifun-ext (fun-ext (Î» s â†’ fun-ext (Î» y â†’
      cong (Î» r â†’ k r y) (â‰¤-irrelevant _ _)))))

-- Extrinsic refinement of the object mapping to
-- operations whose continuations are natural

data TË¢-natcont {A : TSet} : âˆ€ {Ï„ t} â†’ TË¢ A Ï„ t â†’ Set where

  natcont-leaf : âˆ€ {Ï„ t v}
               â†’ TË¢-natcont (leaf {A} {Ï„} {t} v)

  natcont-node : âˆ€ {Ï„ Ï„' t op x p}
                   {k : {t' : Time} â†’ t + op-time op â‰¤ t'
                                    â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'
                                    â†’ TË¢ A Ï„ t'}
               â†’ ({t' t'' : Time} â†’ (p : t + op-time op â‰¤ t')
                                  â†’ (q : t' â‰¤ t'')
                                  â†’ (y : carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t')
                                  â†’ k (â‰¤-trans p q) y â‰¡ TË¢-â‰¤t q (k p y))
               â†’ ({t' : Time} â†’ (q : t + op-time op â‰¤ t')
                              â†’ (y : carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t')
                              â†’ TË¢-natcont (k q y))
               â†’ TË¢-natcont (node {A} {Ï„} {Ï„'} {t} op x k p)

TË¢Ê³ : TSet â†’ Time â†’ Time â†’ Set
TË¢Ê³ A Ï„ t = Î£[ c âˆˆ TË¢ A Ï„ t ] TË¢-natcont c

-- The extrinsic predicate is a proposition

TË¢-natcont-isprop : âˆ€ {A Ï„ t}
                  â†’ {c : TË¢ A Ï„ t}
                  â†’ (p q : TË¢-natcont c)
                  â†’ p â‰¡ q

TË¢-natcont-isprop natcont-leaf natcont-leaf = refl
TË¢-natcont-isprop (natcont-node p q) (natcont-node p' q') =
  congâ‚‚ natcont-node
    (ifun-ext (ifun-ext (fun-ext (Î» r â†’ fun-ext (Î» s â†’ fun-ext (Î» y â†’ uip))))))
    (ifun-ext (fun-ext (Î» r â†’ fun-ext (Î» y â†’ TË¢-natcont-isprop (q r y) (q' r y)))))

-- Monotonicity wrt TSets' time-indices

TË¢-â‰¤t-natcont : âˆ€ {A Ï„ t t'} â†’ (p : t â‰¤ t') â†’ {c : TË¢ A Ï„ t}
              â†’ TË¢-natcont c
              â†’ TË¢-natcont (TË¢-â‰¤t p c)
TË¢-â‰¤t-natcont p natcont-leaf = natcont-leaf
TË¢-â‰¤t-natcont p {c = node op v k _} (natcont-node q r) =
  natcont-node
    (Î» s t y â†’
      trans
        (cong (Î» p â†’ k p y) (â‰¤-irrelevant _ _))
        (q _ _ y))
    (Î» s y â†’
      subst
        TË¢-natcont
        (sym (q _ _ y))
        (TË¢-â‰¤t-natcont s (r (+-monoË¡-â‰¤ (op-time op) p) y)))

TË¢Ê³-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢Ê³ A Ï„ t â†’ TË¢Ê³ A Ï„ t'
TË¢Ê³-â‰¤t p (c , q) = TË¢-â‰¤t p c , TË¢-â‰¤t-natcont p q 

TË¢Ê³-â‰¤t-refl : âˆ€ {A Ï„ t} â†’ (c : TË¢Ê³ A Ï„ t)
            â†’ TË¢Ê³-â‰¤t â‰¤-refl c â‰¡ c

TË¢Ê³-â‰¤t-refl (c , p) =
  dcongâ‚‚ _,_ (TË¢-â‰¤t-refl c) (TË¢-natcont-isprop _ _)

TË¢Ê³-â‰¤t-trans : âˆ€ {A Ï„ t t' t''}
             â†’ (p : t â‰¤ t') â†’ (q : t' â‰¤ t'') â†’ (c : TË¢Ê³ A Ï„ t)
             â†’ TË¢Ê³-â‰¤t q (TË¢Ê³-â‰¤t p c) â‰¡ TË¢Ê³-â‰¤t (â‰¤-trans p q) c

TË¢Ê³-â‰¤t-trans p q (c , r) =
  dcongâ‚‚ _,_ (TË¢-â‰¤t-trans p q c) (TË¢-natcont-isprop _ _)

-- Functorial action on â†’áµ—

TË¢á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B Ï„ t
TË¢á¶  f (leaf v)   =
  leaf (map-carrier f v)
TË¢á¶  f (node op v k q) =
  node op v (Î» p y â†’ TË¢á¶  f (k p y)) q

TË¢á¶ -nat : âˆ€ {A B Ï„} â†’ (f : A â†’áµ— B) â†’ {t t' : â„•}
        â†’ (p : t â‰¤ t') â†’ (c : TË¢ A Ï„ t)
        â†’ TË¢á¶  f (TË¢-â‰¤t p c) â‰¡ TË¢-â‰¤t p (TË¢á¶  f c)
        
TË¢á¶ -nat f p (leaf v) = cong leaf (map-nat f _ v)
TË¢á¶ -nat f p (node op v k q) = refl

TË¢á¶ -natcont : âˆ€ {A B Ï„} â†’ (f : A â†’áµ— B)
            â†’ {t : Time} â†’ {c : TË¢ A Ï„ t}
            â†’ TË¢-natcont c
            â†’ TË¢-natcont (TË¢á¶  f c)
              
TË¢á¶ -natcont f natcont-leaf = natcont-leaf
TË¢á¶ -natcont f {c = node op v k _} (natcont-node p q) =
  natcont-node
    (Î» r s y â†’
      trans (cong (TË¢á¶  f) (p r s y)) (TË¢á¶ -nat f s (k r y)))
    (Î» r y â†’ TË¢á¶ -natcont f (q r y))

TË¢Ê³á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢Ê³ A Ï„ t â†’ TË¢Ê³ B Ï„ t
TË¢Ê³á¶  f (c , p) = TË¢á¶  f c , TË¢á¶ -natcont f p

TË¢Ê³á¶ -nat : âˆ€ {A B Ï„} â†’ (f : A â†’áµ— B) â†’ {t t' : â„•}
         â†’ (p : t â‰¤ t') â†’ (c : TË¢Ê³ A Ï„ t)
         â†’ TË¢Ê³á¶  f (TË¢Ê³-â‰¤t p c) â‰¡ TË¢Ê³-â‰¤t p (TË¢Ê³á¶  f c)

TË¢Ê³á¶ -nat f p (c , q) =
  dcongâ‚‚ _,_ (TË¢á¶ -nat f p c) (TË¢-natcont-isprop _ _)

-- Monotonicity wrt time-gradings

TË¢-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„' t
TË¢-â‰¤Ï„ {A} p (leaf v) =
  leaf (monotone A (+-monoË¡-â‰¤ _ p) v)
TË¢-â‰¤Ï„ p (node op v k q) =
  node op v
    (Î» r y â†’
      TË¢-â‰¤Ï„
        (projâ‚‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p)))
        (k r y))
    (trans
      (projâ‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p)))
      (+-comm _ (op-time op)))

TË¢-â‰¤Ï„-t-nat : âˆ€ {A Ï„ Ï„'} â†’ (p : Ï„ â‰¤ Ï„') â†’ {t t' : â„•}
            â†’ (q : t â‰¤ t') (c : TË¢ A Ï„ t)
            â†’ TË¢-â‰¤Ï„ p (TË¢-â‰¤t q c) â‰¡ TË¢-â‰¤t q (TË¢-â‰¤Ï„ p c)
TË¢-â‰¤Ï„-t-nat {A} p q (leaf v) =
  cong leaf
    (trans
      (monotone-trans A _ _ v)
      (trans
        (cong (Î» r â†’ monotone A r v) (â‰¤-irrelevant _ _))
        (sym (monotone-trans A _ _ v))))
TË¢-â‰¤Ï„-t-nat p q (node op v k r) = refl

TË¢-â‰¤Ï„-natcont : âˆ€ {A Ï„ Ï„' t} â†’ (p : Ï„ â‰¤ Ï„') â†’ {c : TË¢ A Ï„ t}
              â†’ TË¢-natcont c
              â†’ TË¢-natcont (TË¢-â‰¤Ï„ p c)
TË¢-â‰¤Ï„-natcont p natcont-leaf = natcont-leaf
TË¢-â‰¤Ï„-natcont p {c = node {Ï„ = Ï„} op v k u} (natcont-node q r) =
  natcont-node
    (Î» s t y â†’
      trans
        (cong (TË¢-â‰¤Ï„ _) (q s t y))
        (TË¢-â‰¤Ï„-t-nat
          (projâ‚‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans u (+-comm (op-time op) Ï„)) p)))
          t
          (k s y)))
    (Î» s y â†’
      TË¢-â‰¤Ï„-natcont
        (projâ‚‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans u (+-comm (op-time op) Ï„)) p)))
        (r s y))

TË¢Ê³-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢Ê³ A Ï„ t â†’ TË¢Ê³ A Ï„' t
TË¢Ê³-â‰¤Ï„ p (c , q) = TË¢-â‰¤Ï„ p c , TË¢-â‰¤Ï„-natcont p q

TË¢Ê³-â‰¤Ï„-t-nat : âˆ€ {A Ï„ Ï„'} â†’ (p : Ï„ â‰¤ Ï„') â†’ {t t' : â„•}
             â†’ (q : t â‰¤ t') (c : TË¢Ê³ A Ï„ t)
             â†’ TË¢Ê³-â‰¤Ï„ p (TË¢Ê³-â‰¤t q c) â‰¡ TË¢Ê³-â‰¤t q (TË¢Ê³-â‰¤Ï„ p c)

TË¢Ê³-â‰¤Ï„-t-nat p q (c , r) =
  dcongâ‚‚ _,_ (TË¢-â‰¤Ï„-t-nat p q c) (TË¢-natcont-isprop _ _)

-- Packaging it all up into a functor

Táµ’ : TSet â†’ Time â†’ TSet
Táµ’ A Ï„ = tset (Î» t â†’ TË¢Ê³ A Ï„ t) TË¢Ê³-â‰¤t TË¢Ê³-â‰¤t-refl TË¢Ê³-â‰¤t-trans

Tá¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ Táµ’ A Ï„ â†’áµ— Táµ’ B Ï„
Tá¶  f = tset-map (TË¢Ê³á¶  f) (TË¢Ê³á¶ -nat f)


T-â‰¤Ï„ : âˆ€ {A Ï„ Ï„'} â†’ Ï„ â‰¤ Ï„' â†’ Táµ’ A Ï„ â†’áµ— Táµ’ A Ï„'
T-â‰¤Ï„ p = tset-map (TË¢Ê³-â‰¤Ï„ p) (TË¢Ê³-â‰¤Ï„-t-nat p)

-- T is a [_]-module

T-[]-moduleË¢ : âˆ€ {A Ï„ Ï„' t} â†’ TË¢ A Ï„' (t + Ï„) â†’ TË¢ A (Ï„ + Ï„') t
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (leaf v) =
  leaf
    (monotone A
      (â‰¤-reflexive
        (trans
          (trans
            (cong (Ï„' +_) (+-comm t Ï„))
            (sym (+-assoc Ï„' Ï„ t)))
          (cong (_+ t) (+-comm Ï„' Ï„))))
      v)
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (node {Ï„ = Ï„''} op v k p) =
  node op v
    (Î» {t'} q y â†’
      T-[]-moduleË¢
        (k (â‰¤-trans
             (â‰¤-reflexive
               (trans
                 (+-assoc t Ï„ (op-time op))
                   (trans
                     (cong (t +_) (+-comm Ï„ (op-time op)))
                       (sym (+-assoc t (op-time op) Ï„)))))
             (+-monoË¡-â‰¤ Ï„ q))
           y))
    (trans
      (cong (Ï„ +_) p)
      (trans
        (sym (+-assoc Ï„ (op-time op) Ï„''))
        (trans
          (cong (_+ Ï„'') (+-comm Ï„ (op-time op)))
          (+-assoc (op-time op) Ï„ _))))

T-[]-moduleË¢-t-nat : âˆ€ {A Ï„ Ï„' t t'}
                   â†’ (p : t â‰¤ t') â†’ (c : TË¢ A Ï„' (t + Ï„))
                   â†’ T-[]-moduleË¢ (TË¢-â‰¤t (+-mono-â‰¤ p (â‰¤-reflexive refl)) c)
                   â‰¡ TË¢-â‰¤t p (T-[]-moduleË¢ c)

T-[]-moduleË¢-t-nat {A} p (leaf v) =
  cong leaf
    (trans
      (monotone-trans A _ _ v)
      (trans
        (cong (Î» r â†’ monotone A r v) (â‰¤-irrelevant _ _))
        (sym (monotone-trans A _ _ v))))
T-[]-moduleË¢-t-nat p (node op v k q) =
  congâ‚‚ (node op v)
    (ifun-ext (fun-ext (Î» r â†’ fun-ext (Î» y â†’
      cong (Î» s â†’ T-[]-moduleË¢ (k s y)) (â‰¤-irrelevant _ _)))))
    refl

T-[]-moduleË¢-natcont : âˆ€ {A Ï„ Ï„' t} {c : TË¢ A Ï„' (t + Ï„)}
                      â†’ TË¢-natcont c
                      â†’ TË¢-natcont (T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} c)
T-[]-moduleË¢-natcont natcont-leaf =
  natcont-leaf
T-[]-moduleË¢-natcont {A} {Ï„} {Ï„'} {t} {node {Ï„ = Ï„''} op v k _} (natcont-node p q) =
  natcont-node
    (Î» r s y â†’
      trans
      (cong T-[]-moduleË¢
        (trans
          (cong (Î» p â†’ k p y) (â‰¤-irrelevant _ _))
          (p _ _ y)))
      (T-[]-moduleË¢-t-nat s _))
    (Î» r  y â†’
      T-[]-moduleË¢-natcont
        (q
          (â‰¤-trans
            (â‰¤-reflexive
              (trans
                (+-assoc t Ï„ (op-time op))
                (trans
                  (cong (t +_) (+-comm Ï„ (op-time op)))
                  (sym (+-assoc t (op-time op) Ï„)))))
            (+-monoË¡-â‰¤ _ r))
          y))

T-[]-moduleË¢Ê³ : âˆ€ {A Ï„ Ï„' t} â†’ TË¢Ê³ A Ï„' (t + Ï„) â†’ TË¢Ê³ A (Ï„ + Ï„') t
T-[]-moduleË¢Ê³ (c , p) = T-[]-moduleË¢ c , T-[]-moduleË¢-natcont p

T-[]-moduleË¢Ê³-t-nat : âˆ€ {A Ï„ Ï„' t t'}
                    â†’ (p : t â‰¤ t') â†’ (c : TË¢Ê³ A Ï„' (t + Ï„))
                    â†’ T-[]-moduleË¢Ê³ (TË¢Ê³-â‰¤t (+-mono-â‰¤ p (â‰¤-reflexive refl)) c)
                    â‰¡ TË¢Ê³-â‰¤t p (T-[]-moduleË¢Ê³ c)
T-[]-moduleË¢Ê³-t-nat p (c , q) =
  dcongâ‚‚ _,_ (T-[]-moduleË¢-t-nat p c) (TË¢-natcont-isprop _ _)

T-[]-module : âˆ€ {A Ï„ Ï„'} â†’ [ Ï„ ]áµ’ (Táµ’ A Ï„') â†’áµ— Táµ’ A (Ï„ + Ï„')
T-[]-module = tset-map T-[]-moduleË¢Ê³ T-[]-moduleË¢Ê³-t-nat

-- Unit

Î·áµ€ : âˆ€ {A} â†’ A â†’áµ— Táµ’ A 0
Î·áµ€ {A} =
  tset-map
    (Î» v â†’ leaf v , natcont-leaf)
    (Î» p x â†’
      dcongâ‚‚ _,_
        (cong leaf
          (cong
            (Î» q â†’ monotone A q x)
            (â‰¤-irrelevant _ _)))
        (TË¢-natcont-isprop _ _))

-- Multiplication

Î¼Ë¢ : âˆ€ {A Ï„ Ï„'} â†’ {t : Time}
   â†’ TË¢ (Táµ’ A Ï„') Ï„ t â†’ TË¢ A (Ï„ + Ï„') t

Î¼Ë¢ {A} {Ï„} {Ï„'} {t} (leaf (c , p)) =
  T-[]-moduleË¢ (TË¢-â‰¤t (â‰¤-reflexive (+-comm Ï„ t)) c)
Î¼Ë¢ (node op v k p) =
  node op v
    (Î» q y â†’ Î¼Ë¢ (k q y))
    (trans (cong (_+ _) p) (+-assoc (op-time op) _ _))

Î¼Ë¢-t-nat : âˆ€ {A Ï„ Ï„' t t'}
         â†’ (p : t â‰¤ t')
         â†’ (c : TË¢ (Táµ’ A Ï„') Ï„ t)
         â†’ Î¼Ë¢ (TË¢-â‰¤t p c) â‰¡ TË¢-â‰¤t p (Î¼Ë¢ c)
Î¼Ë¢-t-nat p (leaf (c , q)) =
  trans
    (cong T-[]-moduleË¢
      (trans
        (TË¢-â‰¤t-trans _ _ c)
        (trans
          (cong (Î» q â†’ TË¢-â‰¤t q c) (â‰¤-irrelevant _ _))
          (sym (TË¢-â‰¤t-trans _ _ c)))))
    (T-[]-moduleË¢-t-nat p _)
Î¼Ë¢-t-nat p (node op v k q) = refl

Î¼Ë¢-natcont : âˆ€ {A Ï„ Ï„' t} {c : TË¢ (Táµ’ A Ï„') Ï„ t}
           â†’ TË¢-natcont c
           â†’ TË¢-natcont (Î¼Ë¢ c)
Î¼Ë¢-natcont {A} {Ï„} {Ï„'} {t} {leaf (c , p)} natcont-leaf =
  T-[]-moduleË¢-natcont (TË¢-â‰¤t-natcont (â‰¤-reflexive (+-comm Ï„ t)) p)
Î¼Ë¢-natcont {A} {Ï„} {Ï„'} {t} {node op v k _} (natcont-node p q) =
  natcont-node
    (Î» r s y â†’
      trans
        (cong Î¼Ë¢ (p r s y))
        (Î¼Ë¢-t-nat s (k r y)))
    (Î» r y â†’ Î¼Ë¢-natcont (q r y))

Î¼Ë¢Ê³ : âˆ€ {A Ï„ Ï„'} â†’ {t : Time}
    â†’ carrier (Táµ’ (Táµ’ A Ï„') Ï„) t â†’ carrier (Táµ’ A (Ï„ + Ï„')) t
Î¼Ë¢Ê³ (c , p) = Î¼Ë¢ c , Î¼Ë¢-natcont p

Î¼Ë¢Ê³-t-nat : âˆ€ {A Ï„ Ï„' t t'}
          â†’ (p : t â‰¤ t')
          â†’ (c : carrier (Táµ’ (Táµ’ A Ï„') Ï„) t)
          â†’ Î¼Ë¢Ê³ (TË¢Ê³-â‰¤t p c) â‰¡ TË¢Ê³-â‰¤t p (Î¼Ë¢Ê³ c)
Î¼Ë¢Ê³-t-nat p (c , q) =
  dcongâ‚‚ _,_ (Î¼Ë¢-t-nat p c) (TË¢-natcont-isprop _ _)

Î¼áµ€ : âˆ€ {A Ï„ Ï„'} â†’ Táµ’ (Táµ’ A Ï„') Ï„ â†’áµ— Táµ’ A (Ï„ + Ï„')
Î¼áµ€ = tset-map Î¼Ë¢Ê³ Î¼Ë¢Ê³-t-nat


-- Strength

strË¢ : âˆ€ {A B Ï„ Ï„' t}
     â†’ carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) t
     â†’ TË¢ B Ï„ t
     â†’ TË¢ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„ t
     
strË¢ {A} {B} {Ï„} {Ï„'} {t} (vp , vx) (leaf w) =
  leaf (
    (â‰¤-trans vp (â‰¤-reflexive (+-comm t Ï„)) ,
     monotone A (â‰¤-reflexive (cong (_âˆ¸ Ï„') (+-comm t Ï„))) vx) ,
    w)
strË¢ {A} {B} {Ï„' = Ï„''} {t} (vp , vx) (node {Ï„ = Ï„} {Ï„' = Ï„'} op w k p) =
  node op w
    (Î» q y â†’
      strË¢ {A = A} {B = B} {Ï„ = Ï„} {Ï„' = Ï„''}
        (â‰¤-trans
           (â‰¤-trans
             vp
             (â‰¤-trans
               (â‰¤-reflexive (cong (t +_) p))
               (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„)))))
           (+-monoË¡-â‰¤ Ï„ q) ,
         monotone A
           (â‰¤-trans
             (â‰¤-reflexive (cong (Î» Ï„' â†’ t + Ï„' âˆ¸ Ï„'') p))
             (â‰¤-trans
               (â‰¤-reflexive (cong (_âˆ¸ Ï„'') (sym (+-assoc t (op-time op) Ï„))))
               (âˆ¸-monoË¡-â‰¤ Ï„'' (+-monoË¡-â‰¤ Ï„ q))))
           vx)
        (k q y))
    p

strË¢-t-nat : âˆ€ {A B Ï„ Ï„'} â†’ {t t' : â„•} â†’ (p : t â‰¤ t')
           â†’ (x : carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) t Ã— TË¢ B Ï„ t)
           â†’ strË¢ {A = A} {B = B}
               (monotone ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) p (projâ‚ x))
               (TË¢-â‰¤t p (projâ‚‚ x))
           â‰¡ TË¢-â‰¤t p (strË¢ {A = A} {B = B} (projâ‚ x) (projâ‚‚ x))

strË¢-t-nat {A} p (x , leaf v) =
  cong leaf
    (congâ‚‚ _,_
      (congâ‚‚ _,_
        (â‰¤-irrelevant _ _)
        (trans
          (monotone-trans A _ _ (projâ‚‚ x))
          (trans
            (cong (Î» q â†’ monotone A q (projâ‚‚ x)) (â‰¤-irrelevant _ _))
            (sym (monotone-trans A _ _ (projâ‚‚ x))))))
      refl)
strË¢-t-nat {A} p (x , node op v k q) =
  congâ‚‚ (node op v)
    (ifun-ext (fun-ext (Î» r â†’ fun-ext (Î» y â†’
      congâ‚‚ strË¢
        (congâ‚‚ _,_
          (â‰¤-irrelevant _ _)
          (trans
            (monotone-trans A _ _ (projâ‚‚ x))
            (cong (Î» s â†’ monotone A s (projâ‚‚ x)) (â‰¤-irrelevant _ _))))
        refl))))
    refl

strË¢Ê³-natcont : âˆ€ {A B Ï„ Ï„' t}
              â†’ {x : carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) t}
              â†’ {c : TË¢ B Ï„ t}
              â†’ (p : TË¢-natcont c)
              â†’ TË¢-natcont (strË¢ {A} {B} {Ï„} {Ï„'} {t} x c)
strË¢Ê³-natcont natcont-leaf = natcont-leaf
strË¢Ê³-natcont {A} {B} {Ï„} {Ï„'} {t} {x} (natcont-node p q) =
  natcont-node
    (Î» r s y â†’
      trans
        (congâ‚‚ strË¢
          (congâ‚‚ _,_
            (â‰¤-irrelevant _ _)
            (trans
              (cong (Î» p â†’ monotone A p (projâ‚‚ x)) (â‰¤-irrelevant _ _))
              (sym (monotone-trans A _ _ (projâ‚‚ x)))))
          (p r s y))
        (strË¢-t-nat _ _))
    (Î» r y â†’ strË¢Ê³-natcont (q r y))

strË¢Ê³ : âˆ€ {A B Ï„ Ï„' t}
      â†’ carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) t Ã— carrier (Táµ’ B Ï„) t
      â†’ carrier (Táµ’ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„) t
strË¢Ê³ {A} {B} {Ï„} {Ï„'} {t} (x , (c , p)) =
  strË¢ {A} {B} {Ï„} {Ï„'} {t} x c , strË¢Ê³-natcont p

strË¢Ê³-t-nat : âˆ€ {A B Ï„ Ï„' t t'} â†’ (p : t â‰¤ t')
            â†’ (xc : carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A) Ã—áµ— Táµ’ B Ï„) t)
            â†’ strË¢Ê³ {A} {B} {Ï„} {Ï„'}
                (monotone ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A) Ã—áµ— Táµ’ B Ï„) p xc)
            â‰¡ monotone (Táµ’ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„) p (strË¢Ê³ {A} {B} {Ï„} {Ï„'} xc)
strË¢Ê³-t-nat p (x , (c , q)) =
  dcongâ‚‚ _,_ (strË¢-t-nat p (x , c)) (TË¢-natcont-isprop _ _)

stráµ€ : âˆ€ {A B Ï„ Ï„'} â†’ [ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A) Ã—áµ— Táµ’ B Ï„ â†’áµ— Táµ’ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„
stráµ€ {A} {B} {Ï„} {Ï„'} =
  tset-map (strË¢Ê³ {A} {B} {Ï„} {Ï„'}) strË¢Ê³-t-nat

-- Algebraic operations

opáµ€ : âˆ€ {A Ï„} â†’ (op : Op)
    â†’ ConstTSet âŸ¦ param op âŸ§áµ
    Ã—áµ— [ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„)
    â†’áµ— Táµ’ A (op-time op + Ï„)
   
opáµ€ {A} {Ï„} op =
  tset-map
    (Î» { (v , k) â†’
      node op v
        (Î» p y â†’ projâ‚ (map-carrier k (p , y))) refl ,
      natcont-node
        (Î» p q y â†’ cong projâ‚ (map-nat k q (p , y)))
        (Î» p y â†’ projâ‚‚ (map-carrier k (p , y))) })
    (Î» { p (v , k) â†’
      dcongâ‚‚ _,_ refl (TË¢-natcont-isprop _ _) })



-- TODO: figure out the right recursive arguments

-- Semantics of effect handling (every effect
-- handler induces a corresponding monad algebra)

handler-to-algË¢ : âˆ€ {A Ï„ Ï„' t}
                â†’ ((op : Op) â†’ (Ï„'' : Time) â†’ {t' : Time} â†’ t â‰¤ t' â†’ 
                    carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                    ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                      carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ A Ï„'') t'') â†’
                    carrier (Táµ’ A (op-time op + Ï„'')) t')
                â†’ TË¢ (Táµ’ A Ï„') Ï„ t
                â†’ carrier (Táµ’ A (Ï„ + Ï„')) t

handler-to-algË¢ {Ï„ = Ï„} {t = t} h (leaf (c , p)) =
  T-[]-moduleË¢ (TË¢-â‰¤t (â‰¤-reflexive (+-comm Ï„ t)) c) ,
  T-[]-moduleË¢-natcont (TË¢-â‰¤t-natcont (â‰¤-reflexive (+-comm Ï„ t)) p)
handler-to-algË¢ {A} {Ï„' = Ï„'} {t = t} h (node {Ï„ = Ï„''} op v k p) =
  TË¢Ê³-â‰¤Ï„
    (â‰¤-reflexive
      (trans
        (sym (+-assoc (op-time op) Ï„'' Ï„'))
        (cong (_+ Ï„') (sym p))))
    (h op (Ï„'' + Ï„') â‰¤-refl v
      (Î» q y â†’
        handler-to-algË¢
          (Î» op Ï„''' r x k' â†’ h op Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t q) r) x k')
          (k q y)))

handler-to-algË¢Ê³ : âˆ€ {A Ï„ Ï„' t}
                 â†’ ((op : Op) â†’ (Ï„'' : Time) â†’ {t' : Time} â†’ t â‰¤ t' â†’ 
                     carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                     ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                       carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ A Ï„'') t'') â†’
                     carrier (Táµ’ A (op-time op + Ï„'')) t')
                 â†’ carrier (Táµ’ (Táµ’ A Ï„') Ï„) t
                 â†’ carrier (Táµ’ A (Ï„ + Ï„')) t

handler-to-algË¢Ê³ h (c , p) = handler-to-algË¢ h c

handler-to-algË¢Ê³-t-nat : âˆ€ {A Ï„ Ï„' t t'}
                       â†’ (p : t â‰¤ t')
                       â†’ (h : (op : Op) â†’ (Ï„'' : Time) â†’ {t' : Time} â†’ t â‰¤ t' â†’ 
                           carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                           ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                             carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ A Ï„'') t'') â†’
                           carrier (Táµ’ A (op-time op + Ï„'')) t')
                       â†’ (h-nat : (op : Op) â†’ (Ï„'' : Time)
                                â†’ {t' : Time} â†’ (p : t â‰¤ t')
                                â†’ {t'' : Time} â†’ (q : t' â‰¤ t'')
                                â†’ (x : carrier (ConstTSet âŸ¦ param op âŸ§áµ) t')
                                â†’ (k : {t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                                         carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ A Ï„'') t'')
                                â†’ h op Ï„'' (â‰¤-trans p q) x (Î» r y â†’ TË¢Ê³-â‰¤t r (k (+-monoË¡-â‰¤ (op-time op) q) y))  -- TODO: try moving r and q around
                                â‰¡ TË¢Ê³-â‰¤t q (h op Ï„'' p x k))
                       â†’ (c : carrier (Táµ’ (Táµ’ A Ï„') Ï„) t)
                       â†’ handler-to-algË¢ (Î» op Ï„'' q x k â†’ h op Ï„'' (â‰¤-trans p q) x k) (TË¢-â‰¤t p (projâ‚ c))
                       â‰¡ TË¢Ê³-â‰¤t p (handler-to-algË¢Ê³ h c)

handler-to-algË¢Ê³-t-nat p h h-nat (leaf (c , q) , r) =
  trans
    (cong T-[]-moduleË¢Ê³
      (trans
        (TË¢Ê³-â‰¤t-trans _ _ _)
        (trans
          (cong
            (Î» s â†’ TË¢Ê³-â‰¤t s (c , q))
            (â‰¤-irrelevant _ _))
          (sym (TË¢Ê³-â‰¤t-trans _ _ _)))))
    (T-[]-moduleË¢Ê³-t-nat _ _)
handler-to-algË¢Ê³-t-nat {A} {Ï„} {Ï„'} {t} {t'} p h h-nat (node {Ï„ = Ï„''} op v k q , natcont-node s s') =
  trans
    (cong
      (TË¢Ê³-â‰¤Ï„ (â‰¤-reflexive
        (trans (sym (+-assoc (op-time op) Ï„'' Ï„')) (cong (_+ Ï„') (sym q)))))
      (trans
        (trans
          (trans
            ((cong (Î» s â†’ (h op (Ï„'' + Ï„') s v
               (Î» qâ‚ y â†’ handler-to-algË¢ (Î» opâ‚ Ï„''' r â†’
                 h opâ‚ Ï„''' (â‰¤-trans p (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t' qâ‚) r)))
                   (k (â‰¤-trans (+-monoË¡-â‰¤ (op-time op) p) qâ‚) y))))
               (â‰¤-irrelevant _ p)))
            (cong (h op (Ï„'' + Ï„') p v)
              (ifun-ext (fun-ext (Î» r â†’ fun-ext (Î» y â†’
                trans
                  (congâ‚‚ handler-to-algË¢
                    (fun-ext (Î» op â†’ fun-ext (Î» Ï„''' â†’ ifun-ext (fun-ext (Î» r' â†’
                      cong (h op Ï„''') (â‰¤-irrelevant _ _))))))
                    (s _ _ _))
                  (handler-to-algË¢Ê³-t-nat r
                    (Î» opâ‚ Ï„''' râ‚ â†’
                      h opâ‚ Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t (+-monoË¡-â‰¤ (op-time op) p)) râ‚))
                    (Î» op Ï„''' r' r'' x' k' â†’
                      trans
                        (cong (Î» r'' â†’ h op Ï„''' r'' x' _) (â‰¤-irrelevant _ _))
                        (h-nat op Ï„''' _ _ _ _))
                    (k (+-monoË¡-â‰¤ (op-time op) p) y , s' _ y))))))))
          (cong
            (Î» s â†’ h op (Ï„'' + Ï„') s v
              (Î» r y â†’ TË¢Ê³-â‰¤t r (handler-to-algË¢ (Î» opâ‚ Ï„''' râ‚ â†’
                h opâ‚ Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t (+-monoË¡-â‰¤ (op-time op) p)) râ‚))
                 (k (+-monoË¡-â‰¤ (op-time op) p) y))))
            (â‰¤-irrelevant p _)))
        (h-nat op (Ï„'' + Ï„') _ _ _ _)))
    (TË¢Ê³-â‰¤Ï„-t-nat _ _ _)

handler-to-alg : âˆ€ {A Ï„ Ï„'}
               â†’ Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
                  ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ— ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— (Táµ’ A Ï„'')))
                    â‡’áµ— Táµ’ A (op-time op + Ï„'')))
              Ã—áµ— Táµ’ (Táµ’ A Ï„') Ï„ 
              â†’áµ— (Táµ’ A (Ï„ + Ï„'))
              
handler-to-alg =
  tset-map
    (Î» { (h , c) â†’
      handler-to-algË¢Ê³
        (Î» op Ï„'' p x k â†’
          map-carrier (h op Ï„'')
            (p , x ,
             tset-map
               (Î» { (q , y) â†’ TË¢Ê³-â‰¤t q (k â‰¤-refl y) })
               (Î» { q (r , y) â†’ sym (TË¢Ê³-â‰¤t-trans _ _ _) })))
        c })
    (Î» { p (h , c) â†’
      handler-to-algË¢Ê³-t-nat p
        (Î» op Ï„'' pâ‚ x k â†’
          map-carrier (h op Ï„'')
          (pâ‚ ,
           x ,
           tset-map (Î» { (q , y) â†’ TË¢Ê³-â‰¤t q (k â‰¤-refl y) })
           (Î» { q (r , y) â†’ sym (TË¢Ê³-â‰¤t-trans r q (k â‰¤-refl y)) })))
        (Î» op Ï„'' q r x k â†’ 
          trans
            (cong (map-carrier (h op Ï„''))
              (cong (Î» k â†’ (â‰¤-trans q r , x , k))
                (â‰¡áµ—-â‰¡ (Î» { (s , y) â†’ {!!} }))))
            (map-nat (h op Ï„'') r _))
        c })

-}



























{-

-- EVEN OLDER HANDLER EXPERIMENTS

{-# TERMINATING #-}

mutual
  handler-to-algË¢Ê³ : âˆ€ {A Ï„ Ï„' t}
                   â†’ ((op : Op) â†’ (Ï„'' : Time) â†’ {t' : Time} â†’ t â‰¤ t' â†’ 
                       carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                       carrier ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„'')) t' â†’
                       carrier (Táµ’ A (op-time op + Ï„'')) t')
                   â†’ (c : TË¢ (Táµ’ A Ï„') Ï„ t)
                   â†’ TË¢-natcont c
                   â†’ carrier (Táµ’ A (Ï„ + Ï„')) t
   
  handler-to-algË¢Ê³ {Ï„ = Ï„} {t = t} h (leaf (c , p)) q =
    T-[]-moduleË¢ (TË¢-â‰¤t (â‰¤-reflexive (+-comm Ï„ t)) c) ,
    T-[]-moduleË¢-natcont (TË¢-â‰¤t-natcont (â‰¤-reflexive (+-comm Ï„ t)) p)
  handler-to-algË¢Ê³ {A} {Ï„' = Ï„'} {t = t} h (node {Ï„ = Ï„''} op v k p) (natcont-node q q') =
    TË¢Ê³-â‰¤Ï„
      (â‰¤-reflexive
        (trans
          (sym (+-assoc (op-time op) Ï„'' Ï„'))
          (cong (_+ Ï„') (sym p))))
      (h op (Ï„'' + Ï„') â‰¤-refl v
        (tset-map
          (Î» { (r , y) â†’
            handler-to-algË¢Ê³
              (Î» op Ï„''' s x k' â†’ h op Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t r) s) x k')
              (k r y) (q' _ _) })
          (Î» { r (s , y) â†’
            trans
              {!!}
              (handler-to-algË¢Ê³-t-nat r
                (Î» op Ï„''' s' â†’ h op Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t s) s'))
                (Î» op Ï„''' s' s'' x k' â†’
                  {!!})
                (k s y)
                (q' s y)) }))) 

  handler-to-algË¢Ê³-t-nat : âˆ€ {A Ï„ Ï„' t t'}
                         â†’ (p : t â‰¤ t')
                         â†’ (h : (op : Op) â†’ (Ï„'' : Time) â†’ {t' : Time} â†’ t â‰¤ t' â†’ 
                             carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                             carrier ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„'')) t' â†’
                             carrier (Táµ’ A (op-time op + Ï„'')) t')
                         â†’ (h-nat : (op : Op) â†’ (Ï„'' : Time)
                                  â†’ {t' : Time} â†’ (p : t â‰¤ t')
                                  â†’ {t'' : Time} â†’ (q : t' â‰¤ t'')
                                  â†’ (x : carrier (ConstTSet âŸ¦ param op âŸ§áµ) t')
                                  â†’ (k : carrier ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„'')) t')
                                  â†’ h op Ï„'' (â‰¤-trans p q) x (monotone ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„'')) q k)
                                  â‰¡ TË¢Ê³-â‰¤t q (h op Ï„'' p x k))
                         â†’ (c : TË¢ (Táµ’ A Ï„') Ï„ t)
                         â†’ (q : TË¢-natcont c)
                         â†’ handler-to-algË¢Ê³ (Î» op Ï„'' q x k â†’ h op Ï„'' (â‰¤-trans p q) x k) (TË¢-â‰¤t p c) (TË¢-â‰¤t-natcont p q)
                         â‰¡ TË¢Ê³-â‰¤t p (handler-to-algË¢Ê³ h c q)

  handler-to-algË¢Ê³-t-nat = {!!}
-}






{-

-- TODO: figure out the right recursion pattern

-- Semantics of effect handling (the mediating
-- homomorphism induced by a given algebra)

handleË¢ : âˆ€ {A B Ï„ Ï„' t}
        â†’ TË¢ A Ï„ t
        â†’ ((op : Op) â†’ (Ï„'' : Time) â†’
             {t' : Time} â†’ t â‰¤ t' â†’ 
             carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
             ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ B Ï„'') t'') â†’
             carrier (Táµ’ B (op-time op + Ï„'')) t')
        â†’ ({t' : Time} â†’ t + Ï„ â‰¤ t' â†’ carrier A t' â†’ carrier (Táµ’ B Ï„') t')
        â†’ carrier (Táµ’ B (Ï„ + Ï„')) t

handleË¢ {Ï„ = Ï„} {t = t} (leaf v) h k =
  T-[]-moduleË¢Ê³
    (TË¢Ê³-â‰¤t
      (â‰¤-reflexive (+-comm Ï„ t))
      (k (â‰¤-reflexive (+-comm t Ï„)) v))
handleË¢ {Ï„' = Ï„'} {t = t} (node {Ï„ = Ï„''} op v k p) h k' =
  TË¢Ê³-â‰¤Ï„
    (â‰¤-reflexive
      (trans
        (sym (+-assoc (op-time op) Ï„'' Ï„'))
        (cong (_+ Ï„') (sym p))))
    (h op (Ï„'' + Ï„') â‰¤-refl v
      (Î» q y â†’
        handleË¢
          (k q y)
            (Î» op Ï„''' r x k'' â†’
              h op Ï„''' (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t q) r) x k'')
            (Î» r z â†’ k'
              (â‰¤-trans
                (â‰¤-reflexive (cong (t +_) p))
                (â‰¤-trans
                  (â‰¤-trans
                    (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„'')))
                    (+-monoË¡-â‰¤ Ï„'' q))
                  r)) z)))

handleË¢-t-nat : âˆ€ {A B Ï„ Ï„' t t'}
              â†’ (p : t â‰¤ t')
              â†’ (c : TË¢ A Ï„ t)
              â†’ (h : (op : Op) â†’ (Ï„'' : Time) â†’
                       {t' : Time} â†’ t â‰¤ t' â†’ 
                       carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
                       ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                         carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ B Ï„'') t'') â†’
                       carrier (Táµ’ B (op-time op + Ï„'')) t')
              â†’ (k : carrier ([ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')) t)
              â†’ handleË¢
                  (TË¢-â‰¤t p c)
                  (Î» op Ï„'' q x k' â†’ h op Ï„'' (â‰¤-trans p q) x k')
                  (Î» q z â†’ map-carrier k (â‰¤-trans (+-monoË¡-â‰¤ Ï„ p) q , z))
              â‰¡ TË¢Ê³-â‰¤t p (handleË¢ c h (Î» q z â†’ map-carrier k (q , z)))

handleË¢-t-nat {A} {B} {Ï„} {Ï„'} {t} {t'} p (leaf v) h k =
  trans
    (cong T-[]-moduleË¢Ê³
      (trans
        (sym (map-nat k _ _))
        (trans
          (trans
            (cong (map-carrier k)
              (congâ‚‚ _,_
                (â‰¤-irrelevant _ _)
                (trans
                  (monotone-trans A _ _ _)
                  (cong
                    (Î» p â†’ monotone A p v)
                    (â‰¤-irrelevant _ _)))))
            (map-nat k _ _))
          (sym (monotone-trans (Táµ’ B Ï„') _ _ _)))))
    (T-[]-moduleË¢Ê³-t-nat _ _)
handleË¢-t-nat p (node op v k q) h k' =
  {!!}
-}

{-

handleË¢Ê³ : âˆ€ {A B Ï„ Ï„' t}
         â†’ carrier (Táµ’ A Ï„) t
         â†’ ((op : Op) â†’ (Ï„'' : Time) â†’
              {t' : Time} â†’ t â‰¤ t' â†’ 
              carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
              ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                 carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ B Ï„'') t'') â†’
              carrier (Táµ’ B (op-time op + Ï„'')) t')
         â†’ ({t' : Time} â†’ t + Ï„ â‰¤ t' â†’ carrier A t' â†’ carrier (Táµ’ B Ï„') t')
         â†’ carrier (Táµ’ B (Ï„ + Ï„')) t

handleË¢Ê³ (c , p) h k = handleË¢ c h k
-}

{-
handleáµ€ : âˆ€ {A B Ï„ Ï„'}
        â†’ Táµ’ A Ï„
        Ã—áµ— Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
            ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ— ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— (Táµ’ B Ï„'')))
              â‡’áµ— Táµ’ B (op-time op + Ï„'')))
        Ã—áµ— [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')
        â†’áµ— Táµ’ B (Ï„ + Ï„')

handleáµ€ {A} {B} {Ï„} {Ï„'} =
  let handle-map : {t : Time}
                 â†’ carrier (
                     Táµ’ A Ï„ Ã—áµ—
                     Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
                       ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ—
                       [ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ B Ï„'')
                         â‡’áµ— Táµ’ B (op-time op + Ï„''))) Ã—áµ—
                     [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')) t
                 â†’ carrier (Táµ’ B (Ï„ + Ï„')) t
      handle-map =
        Î» { (c , h , k) â†’
          handleË¢Ê³
            c
            (Î» op Ï„'' p x k' â†’
              map-carrier (h op Ï„'') (p , x , tset-map (Î» { (q , y) â†’ k' q y }) {!!}))
            {!!} } in
  tset-map
    handle-map
    {!!}
-}

{-
      handle-map =
        Î» { (c , h , k) â†’
          handleË¢ c
            (Î» op Ï„'' p x k' â†’
              map-carrier (h op Ï„'')
                (p , x ,
                 tset-map
                   (Î» { (q , y) â†’ TË¢-â‰¤t q (k' â‰¤-refl y) })
                   (Î» { q (r , y) â†’ sym (TË¢-â‰¤t-trans _ _ _) })))
            (Î» p x â†’ map-carrier k (p , x)) } in
-}


{-
-- Semantics of effect handling (the mediating
-- homomorphism induced by a given algebra)

handleË¢ : âˆ€ {A B Ï„ Ï„' t}
        â†’ carrier (Táµ’ A Ï„) t
        â†’ ((op : Op) â†’ (Ï„'' : Time) â†’
             {t' : Time} â†’ t â‰¤ t' â†’ 
             carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
             ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ B Ï„'') t'') â†’
             carrier (Táµ’ B (op-time op + Ï„'')) t')
        â†’ ({t' : Time} â†’ t + Ï„ â‰¤ t' â†’ carrier A t' â†’ carrier (Táµ’ B Ï„') t')
        â†’ carrier (Táµ’ B (Ï„ + Ï„')) t
        
handleË¢ {Ï„ = Ï„} {t = t} (leaf v) h k =
  T-[]-moduleË¢
    (TË¢-â‰¤t
      (â‰¤-reflexive (+-comm Ï„ t))
      (k (â‰¤-reflexive (+-comm t Ï„)) v))
handleË¢ {Ï„' = Ï„'} {t = t} (node {Ï„ = Ï„''} op v k refl) h k' =
  TË¢-â‰¤Ï„
    (â‰¤-reflexive (sym (+-assoc (op-time op) Ï„'' Ï„')))
    (h op (Ï„'' + Ï„') â‰¤-refl v
      (Î» q y â†’
        handleË¢
          (k q y)
          (Î» op Ï„''' r x k'' â†’
            h op Ï„'''
              (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t q) r)
              x
              k'')
          (Î» r z â†’
            k' (â‰¤-trans
                 (â‰¤-trans
                   (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„'')))
                   (+-monoË¡-â‰¤ Ï„'' q)) r) z)))

handleáµ€ : âˆ€ {A B Ï„ Ï„'}
        â†’ Táµ’ A Ï„
        Ã—áµ— Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
            ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ— ([ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— (Táµ’ B Ï„'')))
              â‡’áµ— Táµ’ B (op-time op + Ï„'')))
        Ã—áµ— [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')
        â†’áµ— Táµ’ B (Ï„ + Ï„')

handleáµ€ {A} {B} {Ï„} {Ï„'} =
  let handle-map : {t : Time}
                 â†’ carrier (
                     Táµ’ A Ï„ Ã—áµ—
                     Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
                       ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ—
                       [ op-time op ]áµ’ (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ B Ï„'')
                         â‡’áµ— Táµ’ B (op-time op + Ï„''))) Ã—áµ—
                     [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')) t
                 â†’ carrier (Táµ’ B (Ï„ + Ï„')) t
      handle-map =
        Î» { (c , h , k) â†’
          handleË¢ c
            (Î» op Ï„'' p x k' â†’
              map-carrier (h op Ï„'')
                (p , x ,
                 tset-map
                   (Î» { (q , y) â†’ TË¢-â‰¤t q (k' â‰¤-refl y) })
                   (Î» { q (r , y) â†’ sym (TË¢-â‰¤t-trans _ _ _) })))
            (Î» p x â†’ map-carrier k (p , x)) } in
  tset-map handle-map {!!}
    
{-
  tset-map
    (Î» { (c , h , k) â†’
      handleË¢ c (Î» op Ï„'' p x k' â†’
        h op Ï„'' p (x , Î» q y â†’ k' q y)) k })
    ?
-}


-}
