---------------------------------------------------------
-- Free graded monad generated by algebraic operations --
---------------------------------------------------------

open import Function

open import Data.Empty
open import Data.Product
open import Data.Unit hiding (_â‰¤_)

import Relation.Binary.PropositionalEquality as Eq
open Eq hiding ([_])
open Eq.â‰¡-Reasoning

open import Semantics.TSets
open import Semantics.Modality.Future
open import Semantics.Modality.Past

open import Util.Operations
open import Util.Time

module Semantics.Monad where

-- Interpretation of ground types as sets

âŸ¦_âŸ§áµ : GType â†’ Set
âŸ¦ Base B âŸ§áµ = BaseSet B
âŸ¦ Unit âŸ§áµ   = âŠ¤
âŸ¦ Empty âŸ§áµ  = âŠ¥

-- Semantic constants for base types

constáµ— : âˆ€ {B} â†’ BaseSet B â†’ ğŸ™áµ— â†’áµ— ConstTSet (BaseSet B)
constáµ— c = tset-map (Î» _ â†’ c)

-- Object-mapping of the underlying functor

data TË¢ (A : TSet) : (Ï„ : Time) â†’ (t : Time) â†’ Set where  -- 1st time index (Ï„) is the duration of the computation (its time-grading)
                                                          -- 2nd time index (t) is the corresponding TSets' time-index (modal time)
  leaf : âˆ€ {Ï„ t}
       â†’ carrier A (Ï„ + t)
       â†’ TË¢ A Ï„ t

  node : âˆ€ {Ï„ Ï„' t}
       â†’ (op : Op)
       â†’ carrier (ConstTSet âŸ¦ param op âŸ§áµ) t
       â†’ ({t' : Time} â†’ t + op-time op â‰¤ t'                     -- `[ op-time op ] (âŸ¦ arity op âŸ§áµ â‡’áµ— Táµ’ A Ï„)`; more convenient
                      â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'    -- than `âŸ¦ arity op âŸ§áµ â‡’áµ— [ op-time op ] (Táµ’ A Ï„)` for Agda
                      â†’ TË¢ A Ï„ t')                              -- to see that the function `T-[]-moduleË¢` below terminates
       â†’ Ï„' â‰¡ op-time op + Ï„                                    -- abstracting into a variable for easier recursive defs.
       â†’ TË¢ A Ï„' t

-- Monotonicity wrt TSets' time-indices

TË¢-â‰¤t : âˆ€ {A Ï„ t t'} â†’ t â‰¤ t' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„ t'
TË¢-â‰¤t {A} p (leaf a) =
  leaf (monotone A (+-monoÊ³-â‰¤ _ p) a)
TË¢-â‰¤t {A} p (node op v k q) =
  node op v (Î» q y â†’ k (â‰¤-trans (+-monoË¡-â‰¤ (op-time op) p) q) y) q

TË¢-â‰¤t-refl : âˆ€ {A Ï„ t} â†’ (c : TË¢ A Ï„ t) â†’ TË¢-â‰¤t â‰¤-refl c â‰¡ c
TË¢-â‰¤t-refl {A} (leaf v) =
  cong
    leaf
    (trans
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ â‰¤-refl))
      (monotone-refl A v))
TË¢-â‰¤t-refl {A} (node {Ï„} {Ï„'} {t} op v k p) =
  cong
    (Î» (k : ({t' : Time} â†’ t + op-time op â‰¤ t'
                         â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A Ï„ t')) â†’ node op v k p)
    (ifun-ext (fun-ext (Î» q â†’ fun-ext (Î» y â†’
      cong (Î» q â†’ k q y) (â‰¤-irrelevant _ _)))))

TË¢-â‰¤t-trans : âˆ€ {A Ï„ t t' t''} â†’ (p : t â‰¤ t') â†’ (q : t' â‰¤ t'')
            â†’ (c : TË¢ A Ï„ t) â†’ TË¢-â‰¤t q (TË¢-â‰¤t p c) â‰¡ TË¢-â‰¤t (â‰¤-trans p q) c

TË¢-â‰¤t-trans {A} p q (leaf v) =
  cong
    leaf
    (trans
      (monotone-trans A _ _ v)
      (cong (Î» p â†’ monotone A p v) (â‰¤-irrelevant _ _)))
TË¢-â‰¤t-trans {A} p q (node op v k r) =
  cong (Î» (k : ({t' : Time} â†’ _ + op-time op â‰¤ t'
                            â†’ carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t' â†’ TË¢ A _ t'))
                            â†’ node op (monotone (ConstTSet âŸ¦ param op âŸ§áµ) (â‰¤-trans p q) v) k r)
    (ifun-ext (fun-ext (Î» s â†’ fun-ext (Î» y â†’
      cong (Î» r â†’ k r y) (â‰¤-irrelevant _ _)))))

-- Monotonicity wrt time-gradings

TË¢-â‰¤Ï„ : âˆ€ {A Ï„ Ï„' t} â†’ Ï„ â‰¤ Ï„' â†’ TË¢ A Ï„ t â†’ TË¢ A Ï„' t
TË¢-â‰¤Ï„ {A} p (leaf v) =
  leaf (monotone A (+-monoË¡-â‰¤ _ p) v)
TË¢-â‰¤Ï„ p (node op v k q) =
  node op v
    (Î» r y â†’ TË¢-â‰¤Ï„ (projâ‚‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p))) (k r y))
    (trans (projâ‚ (projâ‚‚ (nâ‰¡m+kâ‰¤n' (trans q (+-comm (op-time op) _)) p))) (+-comm _ (op-time op)))

-- Functorial action on â†’áµ—

TË¢á¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ {t : Time} â†’ TË¢ A Ï„ t â†’ TË¢ B Ï„ t
TË¢á¶  (tset-map f) (leaf a)   =
  leaf (f a)
TË¢á¶  (tset-map f) (node op v k q) =
  node op v (Î» p y â†’ TË¢á¶  (tset-map f) (k p y)) q

-- Packaging it all up into a functor

Táµ’ : TSet â†’ Time â†’ TSet
Táµ’ A Ï„ = tset (Î» t â†’ TË¢ A Ï„ t) TË¢-â‰¤t TË¢-â‰¤t-refl TË¢-â‰¤t-trans

Tá¶  : âˆ€ {A B Ï„} â†’ A â†’áµ— B â†’ Táµ’ A Ï„ â†’áµ— Táµ’ B Ï„
Tá¶  f = tset-map (TË¢á¶  f)

T-â‰¤Ï„ : âˆ€ {A Ï„ Ï„'} â†’ Ï„ â‰¤ Ï„' â†’ Táµ’ A Ï„ â†’áµ— Táµ’ A Ï„'
T-â‰¤Ï„ p = tset-map (TË¢-â‰¤Ï„ p)

-- T is a [_]-module

T-[]-moduleË¢ : âˆ€ {A Ï„ Ï„' t} â†’ TË¢ A Ï„' (t + Ï„) â†’ TË¢ A (Ï„ + Ï„') t
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (leaf v) =
  leaf (monotone A (â‰¤-reflexive (trans
                          (trans
                            (cong (Ï„' +_) (+-comm t Ï„))
                            (sym (+-assoc Ï„' Ï„ t)))
                          (cong (_+ t) (+-comm Ï„' Ï„)))) v)
T-[]-moduleË¢ {A} {Ï„} {Ï„'} {t} (node {Ï„ = Ï„''} op v k p) =
  node op v
    (Î» {t'} q y â†’
      T-[]-moduleË¢
        (k (â‰¤-trans
             (â‰¤-reflexive
               (trans
                 (+-assoc t Ï„ (op-time op))
                   (trans
                     (cong (t +_) (+-comm Ï„ (op-time op)))
                       (sym (+-assoc t (op-time op) Ï„)))))
             (+-monoË¡-â‰¤ Ï„ q))
           y))
    (trans
      (cong (Ï„ +_) p)
      (trans
        (sym (+-assoc Ï„ (op-time op) Ï„''))
        (trans
          (cong (_+ Ï„'') (+-comm Ï„ (op-time op)))
          (+-assoc (op-time op) Ï„ _))))

T-[]-module : âˆ€ {A Ï„ Ï„'} â†’ [ Ï„ ]áµ’ (Táµ’ A Ï„') â†’áµ— Táµ’ A (Ï„ + Ï„')
T-[]-module = tset-map T-[]-moduleË¢

-- Unit

Î·áµ€ : âˆ€ {A} â†’ A â†’áµ— Táµ’ A 0
Î·áµ€ = tset-map (Î» v â†’ leaf v)

-- Multiplication

Î¼Ë¢ : âˆ€ {A Ï„ Ï„'} â†’ {t : Time}
   â†’ carrier (Táµ’ (Táµ’ A Ï„') Ï„) t â†’ carrier (Táµ’ A (Ï„ + Ï„')) t
   
Î¼Ë¢ {A} {Ï„} {Ï„'} {t} (leaf c) =
  T-[]-moduleË¢ (monotone (Táµ’ A Ï„') (â‰¤-reflexive (+-comm Ï„ t)) c)
Î¼Ë¢ (node op v k p) =
  node op v (Î» q y â†’ Î¼Ë¢ (k q y)) (trans (cong (_+ _) p) (+-assoc (op-time op) _ _))

Î¼áµ€ : âˆ€ {A Ï„ Ï„'} â†’ Táµ’ (Táµ’ A Ï„') Ï„ â†’áµ— Táµ’ A (Ï„ + Ï„')
Î¼áµ€ = tset-map Î¼Ë¢

-- Strength

strË¢ : âˆ€ {A B Ï„ Ï„' t}
     â†’ carrier ([ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A)) t â†’ carrier (Táµ’ B Ï„) t
     â†’ carrier (Táµ’ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„) t
     
strË¢ {A} {B} {Ï„} {Ï„'} {t} (vp , vx) (leaf w) =
  leaf (
    (â‰¤-trans vp (â‰¤-reflexive (+-comm t Ï„)) ,
     monotone A (â‰¤-reflexive (cong (_âˆ¸ Ï„') (+-comm t Ï„))) vx) ,
    w)
strË¢ {A} {B} {Ï„' = Ï„''} {t} (vp , vx) (node {Ï„ = Ï„} {Ï„' = Ï„'} op w k p) =
  node op w
    (Î» q y â†’
      strË¢ {A = A} {B = B} {Ï„ = Ï„} {Ï„' = Ï„''}
        (â‰¤-trans
           (â‰¤-trans
             vp
             (â‰¤-trans
               (â‰¤-reflexive (cong (t +_) p))
               (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„)))))
           (+-monoË¡-â‰¤ Ï„ q) ,
         monotone A
           (â‰¤-trans
             (â‰¤-reflexive (cong (Î» Ï„' â†’ t + Ï„' âˆ¸ Ï„'') p))
             (â‰¤-trans
               (â‰¤-reflexive (cong (_âˆ¸ Ï„'') (sym (+-assoc t (op-time op) Ï„))))
               (âˆ¸-monoË¡-â‰¤ Ï„'' (+-monoË¡-â‰¤ Ï„ q))))
           vx)
        (k q y))
    p

stráµ€ : âˆ€ {A B Ï„ Ï„'} â†’ [ Ï„ ]áµ’ (âŸ¨ Ï„' âŸ©áµ’ A) Ã—áµ— Táµ’ B Ï„ â†’áµ— Táµ’ (âŸ¨ Ï„' âŸ©áµ’ A Ã—áµ— B) Ï„
stráµ€ {A} {B} {Ï„} {Ï„'} = tset-map Î» { (v , c) â†’ strË¢ {A} {B} {Ï„} {Ï„'} v c }

-- Algebraic operations

-- More standard `âŸ¦ arity op âŸ§áµ â‡’áµ— [ op-time op ] (Táµ’ A Ï„)`
-- presentation compared tot he one used in the def. of `Táµ’`

opáµ€ : âˆ€ {A Ï„} â†’ (op : Op)
    â†’ ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ— (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— [ op-time op ]áµ’ (Táµ’ A Ï„)) â†’áµ— Táµ’ A (op-time op + Ï„)
opáµ€ {A} {Ï„} op =
     tset-map (Î» { (v , k) â†’ node op v (Î» {t'} â†’ k {t'}) refl })
  âˆ˜áµ— mapË£áµ— idáµ— (â‡’áµ—-[] {B = Táµ’ A Ï„} {Ï„ = op-time op})

-- Semantics of effect handling (the mediating
-- homomorphism induced by a given algebra)

handleË¢ : âˆ€ {A B Ï„ Ï„' t}
        â†’ carrier (Táµ’ A Ï„) t
        â†’ ((op : Op) â†’ (Ï„'' : Time) â†’
             {t' : Time} â†’ t â‰¤ t' â†’ 
             carrier (ConstTSet âŸ¦ param op âŸ§áµ) t' â†’
             ({t'' : Time} â†’ t' + op-time op â‰¤ t'' â†’
                carrier (ConstTSet âŸ¦ arity op âŸ§áµ) t'' â†’ carrier (Táµ’ B Ï„'') t'') â†’
             carrier (Táµ’ B (op-time op + Ï„'')) t')
        â†’ ({t' : Time} â†’ t + Ï„ â‰¤ t' â†’ carrier A t' â†’ carrier (Táµ’ B Ï„') t')
        â†’ carrier (Táµ’ B (Ï„ + Ï„')) t
        
handleË¢ {Ï„ = Ï„} {t = t} (leaf v) h k =
  T-[]-moduleË¢
    (TË¢-â‰¤t
      (â‰¤-reflexive (+-comm Ï„ t))
      (k (â‰¤-reflexive (+-comm t Ï„)) v))
handleË¢ {Ï„' = Ï„'} {t = t} (node {Ï„ = Ï„''} op v k refl) h k' =
  TË¢-â‰¤Ï„
    (â‰¤-reflexive (sym (+-assoc (op-time op) Ï„'' Ï„')))
    (h op (Ï„'' + Ï„') â‰¤-refl v
      (Î» q y â†’
        handleË¢
          (k q y)
          (Î» op Ï„''' r x k'' â†’
            h op Ï„'''
              (â‰¤-trans (m+nâ‰¤oâ‡’mâ‰¤o t q) r)
              x
              k'')
          (Î» r z â†’
            k' (â‰¤-trans
                 (â‰¤-trans
                   (â‰¤-reflexive (sym (+-assoc t (op-time op) Ï„'')))
                   (+-monoË¡-â‰¤ Ï„'' q)) r) z)))

handleáµ€ : âˆ€ {A B Ï„ Ï„'}
        â†’ Táµ’ A Ï„ Ã—áµ—
          Î  Op (Î» op â†’ Î  Time (Î» Ï„'' â†’
           ConstTSet âŸ¦ param op âŸ§áµ Ã—áµ— (ConstTSet âŸ¦ arity op âŸ§áµ â‡’áµ— [ op-time op ]áµ’ (Táµ’ B Ï„'')) â‡’áµ— Táµ’ B (op-time op + Ï„''))) Ã—áµ—
          [ Ï„ ]áµ’ (A â‡’áµ— Táµ’ B Ï„')
        â†’áµ— Táµ’ B (Ï„ + Ï„')

handleáµ€ = tset-map (Î» { (c , h , k) â†’
  handleË¢ c (Î» op Ï„'' p x k' â†’
    h op Ï„'' p (x , Î» q y â†’ k' (+-monoË¡-â‰¤ (op-time op) q) y)) k })
