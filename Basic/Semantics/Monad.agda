---------------------------------------------------------
-- Free graded monad generated by algebraic operations --
---------------------------------------------------------

open import Function

open import Data.Empty
open import Data.Product
open import Data.Unit hiding (_โค_)

open import Semantics.TSets
open import Semantics.Modality.Future
open import Semantics.Modality.Past

open import Util.HProp
open import Util.Equality
open import Util.Operations
open import Util.Time

module Semantics.Monad where

-- Interpretation of ground types

-- Note: To apply Adamek's theorem to construct T, likely
-- want to limit them to finite, countable, etc presheaves

โฆ_โงแต : GType โ TSet
โฆ Base B โงแต   = ConstTSet (BaseSet B)
โฆ Unit โงแต     = ๐แต
โฆ Empty โงแต    = ๐แต
โฆ [ ฯ ]แต A โงแต = [ ฯ ]แต โฆ A โงแต

-- The free graded monad generated by the operations in Op

-- TODO: work out the formal details of the corresponding
--       definitions (postulating them for time being)

postulate

  -- Object-mapping

  Tแต : TSet โ Time โ TSet

  -- Functorial action

  Tแถ : โ {A B ฯ} โ A โแต B โ Tแต A ฯ โแต Tแต B ฯ

  -- Monotonicity wrt. gradings

  T-โคฯ : โ {A ฯ ฯ'} โ ฯ โค ฯ' โ Tแต A ฯ โแต Tแต A ฯ'

  -- T is a [_]-module  

  T-[]-module : โ {A ฯ ฯ'} โ [ ฯ ]แต (Tแต A ฯ') โแต Tแต A (ฯ + ฯ')

  -- Unit

  ฮทแต : โ {A} โ A โแต Tแต A 0

  -- Multiplication

  ฮผแต : โ {A ฯ ฯ'} โ Tแต (Tแต A ฯ') ฯ โแต Tแต A (ฯ + ฯ')

  -- Strength

  strแต : โ {A B ฯ ฯ'} โ [ ฯ ]แต (โจ ฯ' โฉแต A) รแต Tแต B ฯ โแต Tแต (โจ ฯ' โฉแต A รแต B) ฯ

  -- Algebraic operations

  opแต : โ {A ฯ} โ (op : Op)
      โ โฆ param op โงแต รแต [ op-time op ]แต (โฆ arity op โงแต โแต Tแต A ฯ) โแต Tแต A (op-time op + ฯ)

  -- T-algebra induced by an effect handler

  alg-of-handler : โ {A ฯ ฯ'}
                 โ ฮ Op (ฮป op โ ฮ Time (ฮป ฯ'' โ
                    โฆ param op โงแต รแต ([ op-time op ]แต (โฆ arity op โงแต โแต (Tแต A ฯ'')))
                      โแต Tแต A (op-time op + ฯ'')))
                 โแต Tแต (Tแต A ฯ') ฯ โแต (Tแต A (ฯ + ฯ'))
